<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<title data-lang-key="pageTitle">تحويل الصور إلى WEBP مجاناً 2025 - ضغط وتحويل JPG و PNG إلى WEBP أون لاين | Skydata</title>

<meta name="description" content="أداة Skydata مجانية 100% لتحويل الصور بسرعة عالية إلى تنسيق WEBP. ضغط صور JPG و PNG إلى WEBP لتقليل حجم الملف وتحسين سرعة تحميل موقعك في عام 2025. معالجة آمنة لصورك مباشرةً في المتصفح.">

<meta name="description" lang="en" content="Skydata's 100% free and very fast Image to WEBP converter for 2025. Compress and convert JPG and PNG files to WEBP format to reduce file size and boost your website loading speed. Secure client-side image processing.">

<meta name="keywords" content="تحويل إلى WEBP, ضغط صور WEBP, JPG إلى WEBP, PNG إلى WEBP, محول WEBP مجاني, تحويل الصور إلى WEBP 2025, ضاغط صور, webp converter free, jpg to webp online, png to webp converter, convertir image en webp, compresser image webp, Bild in WEBP umwandeln, WEBP Bilder komprimieren, convertire immagine in WEBP, comprimere immagine WEBP, convertir foto a WEBP, comprimir fotos a WEBP, конвертировать изображение в WEBP, сжать картинку в WEBP, 图片转WEBP, 图像压缩WEBP, 画像をWEBPに変換, WEBPファイル圧縮, फोटो को WEBP में बदलें, छवियों को WEBP में संपीड़ित करें">
<link rel="manifest" href="/manifest.json">

<meta name="theme-color" content="#2196F3">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "9bc8ff80-a325-4935-ba4d-03e362a3cc5f", 
        });
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* (جديد) تعريف الأنيميشن */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        body {
            font-family: Arial, sans-serif; direction: rtl; 
            background-color: #121212; color: #e0e0e0;
            margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; flex-grow: 1; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background-color: #1e1e1e; border-bottom: 1px solid #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .logo-container { display: flex; align-items: center; }
        .logo-container img { height: 40px; margin-left: 10px; }
        .lang-switcher { display: flex; }
        .lang-switcher a {
            text-decoration: none; color: #007bff; margin: 0 5px;
            font-weight: bold; cursor: pointer; padding: 5px 8px; border-radius: 5px;
        }
        .lang-switcher a.active { background-color: #007bff; color: #ffffff; }

        footer {
            background-color: #1e1e1e; padding: 20px;
            text-align: center; margin-top: auto;
            border-top: 1px solid #333;
        }
        
        main { text-align: center; }
        .webp-tool-box {
            background-color: #1e1e1e; padding: 30px;
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-top: 30px;
            animation: fadeIn 0.5s ease; /* (جديد) أنيميشن للظهور */
        }
        .webp-tool-box h1 { color: #ffffff; margin-bottom: 20px; }

        #image-input { display: none; }
        .file-upload-label {
            display: inline-block; background-color: #007bff; color: #ffffff;
            padding: 12px 25px; font-size: 1.1em; font-weight: bold;
            border-radius: 5px; cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease; /* (جديد) أنيميشن سلس */
        }
        .file-upload-label:hover { 
            background-color: #0056b3;
            transform: scale(1.03); /* (جديد) حركة عند التمرير */
        }
        
        .quality-settings {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .quality-settings label {
            font-size: 1.1em;
            margin-left: 10px;
        }
        .quality-settings input[type="range"] {
            width: 50%;
            cursor: pointer;
        }
        .quality-settings #quality-value {
            color: #fff;
            font-weight: bold;
            margin-right: 15px;
            width: 40px;
        }
        
        #preview-area {
            margin-top: 20px; min-height: 100px;
            display: none; border: 1px solid #333;
            background-color: #121212; padding: 10px; border-radius: 5px;
        }
        .preview-single-image {
            height: 120px; width: auto; max-width: 100%;
            border-radius: 5px; border: 2px solid #444;
        }
        #preview-multi-text {
            font-size: 1.1em; color: #e0e0e0; margin-bottom: 15px;
        }

        /* (جديد) تعديل منطقة التقدم */
        #progress-area { 
            padding: 20px; 
            display: block; 
        }
        #progress-spinner {
            display: none; /* مخفي افتراضياً */
            margin-bottom: 15px;
        }
        .progress-circle {
            width: 60px; height: 60px; border: 8px solid #333;
            border-top-color: #007bff; border-radius: 50%;
            margin: 0 auto; animation: spin 1s linear infinite;
        }
        #progress-percent {
            font-size: 1.3em; font-weight: bold;
            color: #ffffff; margin-top: 10px; display: block;
        }
        #progress-status { font-size: 1.1em; color: #e0e0e0; }

        #button-area { margin-top: 20px; min-height: 50px; }
        #download-all-area { margin: 20px 0; display: none; }
        #reset-area { margin-top: 20px; min-height: 50px; display: none; }

        #results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        .result-item {
            background-color: #121212;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: right;
            animation: fadeIn 0.5s ease; /* (جديد) أنيميشن للظهور */
        }
        .result-item h3 {
            color: #fff; margin-top: 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .result-item img {
            width: 100%; height: auto;
            border-radius: 5px; margin-bottom: 15px;
        }
        .size-comparison {
            font-size: 1.1em; margin-bottom: 10px;
        }
        .old-size {
            color: #e74c3c;
            text-decoration: line-through;
        }
        .new-size {
            color: #28a745;
            font-weight: bold; margin: 0 5px;
        }
        .percent-saved {
            color: #28a745;
            font-weight: bold; display: block;
            margin-top: 8px; font-size: 1.2em;
        }
        .result-item .cta-button {
            width: 100%; margin-top: 15px;
        }
        
        .cta-button {
            display: inline-block; background-color: #007bff; color: #ffffff;
            padding: 12px 25px; font-size: 1.1em; font-weight: bold;
            text-decoration: none; border-radius: 5px; border: none;
            cursor: pointer; 
            transition: all 0.3s ease; /* (جديد) أنيميشن سلس */
        }
        .cta-button:hover {
            transform: scale(1.03); /* (جديد) حركة عند التمرير */
        }
        .cta-button.blue { background-color: #007bff; }
        .cta-button.green { background-color: #28a745; }
        .cta-button.orange { background-color: #fd7e14; }
        .cta-button.red { background-color: #dc3545; }
        
        .cta-button.blue:hover { background-color: #0056b3; }
        .cta-button.green:hover { background-color: #218838; }
        .cta-button.orange:hover { background-color: #e66900; }
        .cta-button.red:hover { background-color: #c82333; }

        .cta-button:disabled { background-color: #555; cursor: not-allowed; }

        .back-button { 
            background-color: #555; margin-top: 50px; 
            font-size: 1.1em; padding: 10px 20px;
        }
        .back-button:hover { background-color: #444; }

        .modal-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: #1e1e1e; color: #e0e0e0;
            border-radius: 8px; width: 90%; max-width: 600px;
            max-height: 80vh; display: flex; flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { margin: 0; color: #fff; }
        .modal-close-btn {
            font-size: 1.5em; font-weight: bold; color: #aaa;
            cursor: pointer; background: none; border: none;
        }
        .modal-close-btn:hover { color: #fff; }
        
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-image-item {
            display: flex; align-items: center; justify-content: space-between;
            background-color: #121212; border: 1px solid #333;
            border-radius: 5px; padding: 10px; margin-bottom: 10px;
        }
        .modal-image-item img {
            height: 60px; width: auto; border-radius: 4px; margin-left: 10px;
        }
        .modal-image-item span {
            flex-grow: 1; font-size: 0.9em;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        .modal-footer {
            padding: 15px 20px; border-top: 1px solid #333; text-align: left;
        }
        
        .delete-button {
          position: relative;
          padding: 0.5em;
          border: none;
          background: transparent;
          cursor: pointer;
          font-size: 1em;
          transition: transform 0.2s ease;
        }
        .trash-svg {
          width: 4em;
          height: 4em;
          transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
          filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
          overflow: visible;
        }
        #lid-group {
          transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .delete-button:hover #lid-group {
          transform: rotate(-28deg) translateY(2px);
        }
        .delete-button:active #lid-group {
          transform: rotate(-12deg) scale(0.98);
        }
        .delete-button:hover .trash-svg {
          transform: scale(1.08) rotate(3deg);
        }
        .delete-button:active .trash-svg {
          transform: scale(0.96) rotate(-1deg);
        }
        .modal-image-item .delete-button {
            font-size: 0.7em;
            padding: 0;
            flex-shrink: 0;
        }
        
        /* (جديد) تنسيق النص التعليمي */
        .instruction-box {
            background-color: #1e1e1e;
            padding: 20px 30px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: right; /* ضمان النص لليمين */
            animation: fadeIn 0.5s ease;
        }
        .instruction-box h2 {
            color: #fff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .instruction-box h3 {
            color: #007bff;
            margin-top: 25px;
        }
        .instruction-box p, .instruction-box ul {
            font-size: 1.1em;
            line-height: 1.7;
            color: #e0e0e0;
        }
        .instruction-box ul {
            padding-right: 20px;
        }
        .instruction-box .privacy-note {
            font-weight: bold;
            color: #28a745; /* أخضر */
            margin-top: 15px;
        }

        @media (max-width: 600px) {
            .container { padding: 10px; }
            header { padding: 10px 15px; }
            .webp-tool-box { padding: 20px; }
            .webp-tool-box h1 { font-size: 1.8em; }
            .quality-settings { flex-direction: column; }
            .quality-settings input[type="range"] { width: 90%; }
            .modal-content { width: 95%; max-height: 90vh; }
            .instruction-box { padding: 20px; }
        }
        @media (max-width: 380px) {
            .logo-container img { height: 30px; }
        }

    </style>
    </head>
<body>

    <header>
        <div class="logo-container">
            <img src="https://i.ibb.co/hJ2nq38z/clouddata.webp" alt="شعار CloudData">
            <img src="https://i.ibb.co/v9zLrFg/skydata.webp" alt="شعار Skydata">
        </div>
        <div class="lang-switcher">
            <a href="#" id="lang-ar" class="active" onclick="setLanguage('ar'); return false;">AR</a>
            <a href="#" id="lang-en" onclick="setLanguage('en'); return false;">EN</a>
        </div>
    </header>

    <div class="container">
        
        <main>
            <div class="webp-tool-box">
                <h1 data-lang-key="toolTitle">أداة تحويل الصور إلى WEBP</h1>
                
                <label for="image-input" class="file-upload-label" id="upload-label" data-lang-key="selectImages">اختر الصور (حد أقصى 20)</label>
                <input type="file" id="image-input" multiple accept="image/*">
                
                <div class="quality-settings">
                    <label for="quality-slider" data-lang-key="qualityLabel">جودة WEBP:</label>
                    <span id="quality-value">0.2</span>
                    <input type="range" id="quality-slider" min="0.1" max="1.0" step="0.1" value="0.2">
                </div>
                
                <div id="preview-area">
                    </div>

                <div id="progress-area">
                    <div id="progress-spinner" style="display: none;">
                        <div class="progress-circle"></div>
                        <span id="progress-percent">0%</span>
                    </div>
                    <p id="progress-status" data-lang-key="statusReady">...</p>
                </div>

                <div id="button-area">
                    </div>

                <div id="download-all-area">
                    </div>

                <div id="reset-area">
                    </div>
                
                <div id="results-container">
                    </div>

            </div>

            <div class="instruction-box">
                <h2 data-lang-key="instructionTitle">دليل استخدام أداة تحويل WEBP</h2>
                
                <p data-lang-key="whatIsWebp">
                    صورة ال Webp هيا ادات ضغط الصور وتقليل من حجم الصور مع الحفاظ على جودتها. مناسبة للمطورين و من يريد تقليل مساحة الصور على جهازه.
                </p>
                
                <h3 data-lang-key="howToUse">كيفية الاستخدام</h3>
                <ul>
                    <li data-lang-key="step1">1. اختر الصور الذي تريدها (حتى 20 صورة).</li>
                    <li data-lang-key="step2">2. اضغط على زر البدأ.</li>
                    <li data-lang-key="step3">3. انتظر قليلا بينما يتم تحويل.</li>
                    <li data-lang-key="step4">4. قم بتحميل الصور أما كلها في ملف zip أو عن طريق زر تحميل أسفلها.</li>
                </ul>
                
                <h3 data-lang-key="qualityTitle">شريط الجودة</h3>
                <p data-lang-key="qualityDesc">
                    يمكنك اختيار النسبة الذي تريدها. لكن إذا كنت تبحث عن جدوى أفضل مع حجم افضل، الإختيار الأمثل هو 0.2 وهو الخيار المعتمد.
                </p>
                
                <hr style="border-color: #333; margin-top: 25px;">
                
                <p data-lang-key="skydataPromise">
                    يقدم لكم skydata هذه الخدمة بأفضل جودة ممكنة وبسرعة خارقة. تحويل صورك الى صور مظغوطة أو صور ويب مجانا وبدون حدود استخدام.
                </p>
                <p class="privacy-note" data-lang-key="privacyNote">
                    + حماية خصوصيتك و تشفير البيانات الخاصة بك (كل التحويل يتم على جهازك).
                </p>
            </div>

            <a href="index.html" class="cta-button back-button" data-lang-key="backToHome">العودة للرئيسية</a>
        </main>
        
    </div> <footer style="margin-top: auto;">
        </footer>

    <div class="modal-overlay" id="preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-lang-key="modalTitle">معاينة الصور</h2>
                <button class="modal-close-btn" id="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                </div>
            <div class="modal-footer">
                <button class="cta-button red" id="modal-delete-all" data-lang-key="modalDeleteAll">حذف الكل</button>
            </div>
        </div>
    </div>


    <script>
        // --- 1. قاموس الترجمة (مدمج) ---
        const translations = {
            "ar": {
                "pageTitle": "تحويل الصور إلى WEBP - Skydata",
                "toolTitle": "أداة تحويل الصور إلى WEBP",
                "selectImages": "اختر الصور (حد أقصى 20)",
                "qualityLabel": "جودة WEBP:",
                "maxImagesError": "لا يمكن اختيار أكثر من 20 صورة دفعة واحدة.",
                "startButton": "ابدأ التحويل ({count})",
                "statusReady": "اختر صورة واحدة أو أكثر...",
                "statusSelected": " تم اختيار {count} صور. جاهز للبدء.",
                "statusConverting": "جاري تحويل الصورة {current} من {total}...",
                "statusZipping": "جاري ضغط الملفات... يرجى الانتظار.",
                "statusDone": "اكتمل التحويل!",
                "oldSize": "الحجم القديم:",
                "newSize": "الحجم الجديد:",
                "saved": "تم توفير:",
                "download": "تحميل (.webp)",
                "downloadAll": "تحميل الكل (.zip)",
                "resetButton": "تحويل ملفات جديدة",
                "backToHome": "العودة للرئيسية",
                "previewButton": "معاينة ({count})",
                "modalTitle": "معاينة الصور",
                "modalDeleteAll": "حذف الكل",
                "modalNoImages": "لا توجد صور لعرضها. سيتم إغلاق النافذة.",
                "instructionTitle": "دليل استخدام أداة تحويل WEBP",
                "whatIsWebp": "صورة ال Webp هيا ادات ضغط الصور وتقليل من حجم الصور مع الحفاظ على جودتها. مناسبة للمطورين و من يريد تقليل مساحة الصور على جهازه.",
                "howToUse": "كيفية الاستخدام",
                "step1": "1. اختر الصور الذي تريدها (حتى 20 صورة).",
                "step2": "2. اضغط على زر البدأ.",
                "step3": "3. انتظر قليلا بينما يتم تحويل.",
                "step4": "4. قم بتحميل الصور أما كلها في ملف zip أو عن طريق زر تحميل أسفلها.",
                "qualityTitle": "شريط الجودة",
                "qualityDesc": "يمكنك اختيار النسبة الذي تريدها. لكن إذا كنت تبحث عن جدوى أفضل مع حجم افضل، الإختيار الأمثل هو 0.2 وهو الخيار المعتمد.",
                "skydataPromise": "يقدم لكم skydata هذه الخدمة بأفضل جودة ممكنة وبسرعة خارقة. تحويل صورك الى صور مظغوطة أو صور ويب مجانا وبدون حدود استخدام.",
                "privacyNote": "+ حماية خصوصيتك و تشفير البيانات الخاصة بك (كل التحويل يتم على جهازك)."
            },
            "en": {
                "pageTitle": "Image to WEBP Converter - Skydata",
                "toolTitle": "Image to WEBP Converter",
                "selectImages": "Select Images (Max 20)",
                "qualityLabel": "WEBP Quality:",
                "maxImagesError": "Cannot select more than 20 images at once.",
                "startButton": "Start Conversion ({count})",
                "statusReady": "Select one or more images...",
                "statusSelected": "{count} images selected. Ready to start.",
                "statusConverting": "Converting image {current} of {total}...",
                "statusZipping": "Zipping files... Please wait.",
                "statusDone": "Conversion Complete!",
                "oldSize": "Old Size:",
                "newSize": "New Size:",
                "saved": "Saved:",
                "download": "Download (.webp)",
                "downloadAll": "Download All (.zip)",
                "resetButton": "Convert New Files",
                "backToHome": "Back to Home",
                "previewButton": "Preview ({count})",
                "modalTitle": "Image Preview",
                "modalDeleteAll": "Delete All",
                "modalNoImages": "No images to display. Closing modal.",
                "instructionTitle": "WEBP Converter Guide",
                "whatIsWebp": "WEBP is an image format that provides superior compression for images on the web, reducing file size while maintaining quality. It's suitable for developers and anyone wanting to save storage space.",
                "howToUse": "How to Use",
                "step1": "1. Select the images you want (up to 20).",
                "step2": "2. Press the Start button.",
                "step3": "3. Wait a moment while conversion is in progress.",
                "step4": "4. Download the images, either all in a .zip file or individually using the download button below each image.",
                "qualityTitle": "Quality Bar",
                "qualityDesc": "You can choose the quality ratio you want. If you are looking for the best quality with the best size reduction, the optimal choice is 0.2, which is the default.",
                "skydataPromise": "Skydata offers you this service with the best possible quality and blazing speed. Convert your images to compressed or webp images for free and without limits.",
                "privacyNote": "+ Your privacy is protected and your data is encrypted (all conversion happens on your device)."
            }
        };

        // --- 2. متغير اللغة الحالي ---
        let currentLang = 'ar'; 

        // --- 3. دالة تبديل اللغة (كما هي) ---
        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
            document.getElementById('lang-ar').classList.toggle('active', lang === 'ar');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');

            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    let text = translations[lang][key];
                    if (selectedFiles.length > 0) {
                        text = text.replace('{count}', selectedFiles.length);
                    }
                    element.innerText = text;
                }
            });
            renderPreviewArea();
        }
        
        // --- 4. منطق تحويل WEBP (مدمج مع منطق المعاينة) ---

        // عناصر الصفحة
        const imageInput = document.getElementById('image-input');
        const qualitySlider = document.getElementById('quality-slider');
        const qualityValue = document.getElementById('quality-value');
        const previewArea = document.getElementById('preview-area');
        const progressArea = document.getElementById('progress-area');
        const progressStatus = document.getElementById('progress-status');
        const progressSpinner = document.getElementById('progress-spinner'); // (جديد)
        const progressPercent = document.getElementById('progress-percent'); // (جديد)
        const buttonArea = document.getElementById('button-area');
        const resultsContainer = document.getElementById('results-container');
        const downloadAllArea = document.getElementById('download-all-area');
        const resetArea = document.getElementById('reset-area');
        const uploadLabel = document.getElementById('upload-label');
        
        // عناصر النافذة المنبثقة
        const modal = document.getElementById('preview-modal');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalDeleteAllBtn = document.getElementById('modal-delete-all');

        let selectedFiles = [];
        let objectUrls = [];
        let convertedBlobs = [];

        qualitySlider.addEventListener('input', () => {
            qualityValue.innerText = qualitySlider.value;
        });

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        function clearObjectUrls() {
            objectUrls.forEach(url => URL.revokeObjectURL(url));
            objectUrls = [];
        }

        function createDownloadLink(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateStatusMessage(element, key, values = {}) {
            let text = translations[currentLang][key] || '';
            if (values.count) text = text.replace('{count}', values.count);
            if (values.current) text = text.replace('{current}', values.current);
            if (values.total) text = text.replace('{total}', values.total);
            element.innerText = text;
        }

        // --- (مُصلح) دالة عرض المعاينة ---
        function renderPreviewArea() {
            previewArea.innerHTML = '';
            buttonArea.innerHTML = '';

            if (selectedFiles.length === 0) {
                previewArea.style.display = 'none'; // إخفاء المعاينة
                progressArea.style.display = 'block'; // إظهار رسالة الحالة
                progressSpinner.style.display = 'none'; // (جديد) إخفاء الدائرة
                updateStatusMessage(progressStatus, 'statusReady');
                return;
            }

            // --- (هذا هو الإصلاح) ---
            progressArea.style.display = 'none'; // إخفاء رسالة "اختر صور"
            previewArea.style.display = 'block'; // إظهار حاوية المعاينة
            // ------------------------

            if (selectedFiles.length === 1) {
                const file = selectedFiles[0];
                const url = URL.createObjectURL(file);
                objectUrls.push(url);
                previewArea.innerHTML = `<img src="${url}" class="preview-single-image" alt="${file.name}">`;
            
            } else {
                const text = document.createElement('p');
                text.id = 'preview-multi-text';
                updateStatusMessage(text, 'statusSelected', { count: selectedFiles.length });
                
                const previewButton = document.createElement('button');
                previewButton.className = 'cta-button orange';
                previewButton.id = 'open-modal-btn';
                updateStatusMessage(previewButton, 'previewButton', { count: selectedFiles.length });
                
                previewButton.onclick = openModal;
                
                previewArea.appendChild(text);
                previewArea.appendChild(previewButton);
            }
            
            const startButton = document.createElement('button');
            startButton.className = 'cta-button blue';
            startButton.id = 'start-btn';
            updateStatusMessage(startButton, 'startButton', { count: selectedFiles.length });
            startButton.onclick = startConversion;
            buttonArea.appendChild(startButton);
        }

        function openModal() {
            renderModalBody();
            modal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function renderModalBody() {
            modalBody.innerHTML = '';
            if (selectedFiles.length === 0) {
                updateStatusMessage(modalBody, 'modalNoImages');
                setTimeout(closeModal, 1500);
                return;
            }
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'modal-image-item';
                const url = URL.createObjectURL(file);
                objectUrls.push(url);
                const deleteButtonHTML = `
                <button aria-label="Delete item" class="delete-button" data-index="${index}">
                  <svg class="trash-svg" viewBox="0 -10 64 74" xmlns="http://www.w3.org/2000/svg"><g id="trash-can"><rect x="16" y="24" width="32" height="30" rx="3" ry="3" fill="#e74c3c"></rect><g transform-origin="12 18" id="lid-group"><rect x="12" y="12" width="40" height="6" rx="2" ry="2" fill="#c0392b"></rect><rect x="26" y="8" width="12" height="4" rx="2" ry="2" fill="#c0392b"></rect></g></g></svg>
                </button>`;
                item.innerHTML = `<img src="${url}" alt="${file.name}"><span>${file.name}</span>${deleteButtonHTML}`;
                modalBody.appendChild(item);
            });
        }
        
        // --- (مُصلح) دالة إعادة الضبط ---
        function resetTool() {
            selectedFiles = [];
            convertedBlobs = [];
            clearObjectUrls();
            imageInput.value = null;
            
            resultsContainer.innerHTML = '';
            buttonArea.innerHTML = '';
            downloadAllArea.innerHTML = '';
            downloadAllArea.style.display = 'none';
            resetArea.innerHTML = '';
            resetArea.style.display = 'none';
            previewArea.innerHTML = '';
            previewArea.style.display = 'none'; // إخفاء المعاينة
            
            progressArea.style.display = 'block'; // إظهار رسالة الحالة
            progressSpinner.style.display = 'none'; // (جديد) إخفاء الدائرة
            updateStatusMessage(progressStatus, 'statusReady'); // ضبط رسالة الحالة
            
            uploadLabel.style.display = 'inline-block';
        }

        // --- (مُصلح) مستمع اختيار الصور ---
        imageInput.addEventListener('change', (e) => {
            // 1. تنظيف الحالة السابقة
            clearObjectUrls();
            convertedBlobs = [];
            resultsContainer.innerHTML = '';
            downloadAllArea.style.display = 'none';
            resetArea.style.display = 'none';
            
            let files = Array.from(e.target.files);

            if (files.length > 20) {
                alert(translations[currentLang].maxImagesError);
                files = files.slice(0, 20);
            }
            
            selectedFiles = files;
            
            // 2. عرض المعاينة أو رسالة "اختر"
            renderPreviewArea(); 
        });
        
        function convertImageToWebp(file, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas toBlob failed'));
                            }
                        }, 'image/webp', parseFloat(quality));
                    };
                    img.onerror = (e) => reject(new Error('Image failed to load: ' + e));
                    img.src = e.target.result;
                };
                reader.onerror = (e) => reject(new Error('FileReader failed: ' + e));
                reader.readAsDataURL(file);
            });
        }
        
        function displayResult(originalFile, webpBlob) {
            const oldSize = originalFile.size;
            const newSize = webpBlob.size;
            const percentSaved = Math.round(((oldSize - newSize) / oldSize) * 100);
            const originalName = originalFile.name.split('.').slice(0, -1).join('.') || originalFile.name;
            
            const webpUrl = URL.createObjectURL(webpBlob);
            objectUrls.push(webpUrl);

            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';

            resultItem.innerHTML = `
                <h3>${originalName}.webp</h3>
                <img src="${webpUrl}" alt="${originalName} as WEBP">
                <div class="size-comparison">
                    <span data-lang-key="oldSize">${translations[currentLang].oldSize}</span>
                    <span class="old-size">${formatBytes(oldSize)}</span>
                    <span data-lang-key="newSize">${translations[currentLang].newSize}</span>
                    <span class="new-size">${formatBytes(newSize)}</span>
                </div>
                <span class="percent-saved" data-lang-key="saved" style="color: ${percentSaved > 0 ? '#28a745' : '#e0e0e0'};">
                    ${translations[currentLang].saved} ${percentSaved > 0 ? percentSaved : 0}%
                </span>
                <button class="cta-button green" data-filename="${originalName}.webp" data-lang-key="download">
                    ${translations[currentLang].download}
                </button>
            `;
            
            resultItem.querySelector('.cta-button.green').addEventListener('click', () => {
                createDownloadLink(webpBlob, `${originalName}.webp`);
            });

            resultsContainer.appendChild(resultItem);
        }

        async function startConversion() {
            if (selectedFiles.length === 0) return;

            previewArea.style.display = 'none';
            buttonArea.innerHTML = '';
            uploadLabel.style.display = 'none';
            progressArea.style.display = 'block';
            progressSpinner.style.display = 'block'; // (جديد) إظهار الدائرة
            resultsContainer.innerHTML = '';
            downloadAllArea.innerHTML = '';
            resetArea.innerHTML = '';
            convertedBlobs = [];
            clearObjectUrls();
            
            const quality = qualitySlider.value;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const percent = Math.round(((i + 1) / selectedFiles.length) * 100);
                progressPercent.innerText = `${percent}%`; // (جديد) تحديث النسبة
                updateStatusMessage(progressStatus, 'statusConverting', { current: i + 1, total: selectedFiles.length });

                try {
                    const webpBlob = await convertImageToWebp(file, quality);
                    const originalName = file.name.split('.').slice(0, -1).join('.') || file.name;
                    
                    convertedBlobs.push({ blob: webpBlob, name: `${originalName}.webp` });
                    displayResult(file, webpBlob);

                } catch (error) {
                    console.error("Error converting file:", file.name, error);
                }
            }

            updateStatusMessage(progressStatus, 'statusDone');
            progressSpinner.style.display = 'none'; // (جديد) إخفاء الدائرة
            progressPercent.innerText = ''; // (جديد) إخفاء النسبة

            if (convertedBlobs.length > 1) {
                downloadAllArea.style.display = 'block';
                const downloadAllButton = document.createElement('button');
                downloadAllButton.className = 'cta-button green';
                downloadAllButton.id = 'download-all-btn';
                updateStatusMessage(downloadAllButton, 'downloadAll');
                downloadAllButton.onclick = downloadAllAsZip;
                downloadAllArea.appendChild(downloadAllButton);
            }

            resetArea.style.display = 'block';
            const resetButton = document.createElement('button');
            resetButton.className = 'cta-button red';
            resetButton.id = 'reset-btn';
            updateStatusMessage(resetButton, 'resetButton');
            resetButton.onclick = resetTool;
            resetArea.appendChild(resetButton);
        }

        async function downloadAllAsZip() {
            if (convertedBlobs.length === 0) return;

            progressArea.style.display = 'block';
            updateStatusMessage(progressStatus, 'statusZipping');
            
            try {
                const zip = new JSZip();
                convertedBlobs.forEach(item => {
                    zip.file(item.name, item.blob);
                });
                const zipBlob = await zip.generateAsync({ type: "blob" });
                createDownloadLink(zipBlob, "skydata_webp_files.zip");

            } catch (error) {
                console.error("Error zipping files:", error);
            } finally {
                progressArea.style.display = 'none';
            }
        }
        
        modalCloseBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        modalDeleteAllBtn.addEventListener('click', () => {
            selectedFiles = [];
            clearObjectUrls();
            renderModalBody();
            renderPreviewArea();
        });

        modalBody.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-button');
            if (deleteButton) {
                const index = parseInt(deleteButton.getAttribute('data-index'), 10);
                selectedFiles.splice(index, 1);
                clearObjectUrls();
                renderModalBody();
                renderPreviewArea();
            }
        });

        // --- (مُصلح) تشغيل الصفحة ---
        setLanguage(currentLang);
        resetTool(); // يبدأ الصفحة بالحالة النظيفة (يُظهر "اختر...")
        
    </script>
    </body>
</html>