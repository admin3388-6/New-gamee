<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-lang-key="pageTitle">SkyData - ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "9bc8ff80-a325-4935-ba4d-03e362a3cc5f",
    });
  });
</script>
<style>
  /* --- (ÿ¨ŸÖŸäÿπ ÿ£ŸÉŸàÿßÿØ CSS ŸÉŸÖÿß ŸáŸä ÿ™ŸÖÿßŸÖÿßŸã - ŸÑÿß ÿ™ÿ∫ŸäŸäÿ± ŸáŸÜÿß) --- */
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes spin { to { transform: rotate(360deg); } }
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    direction: rtl; 
    background-color: #121212; 
    color: #e0e0e0;
    margin: 0; padding: 0; 
    display:flex; flex-direction: column; 
    align-items:center; min-height:100vh; 
  }
  
  header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; background-color: #1e1e1e;
      border-bottom: 1px solid #333;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      width: 100%;
      z-index: 100;
      position: fixed; 
      top: 0;
  }
  .logo-container { display: flex; align-items: center; }
  .logo-container img { height: 35px; margin-left: 10px; }
  .lang-switcher { display: flex; align-items: center; }
  .lang-switcher a { text-decoration: none; color: #007bff; margin: 0 3px; font-weight: bold; cursor: pointer; padding: 4px 7px; border-radius: 5px; transition: all 0.2s ease; }
  .lang-switcher a.active { background-color: #007bff; color: #ffffff; }
  .container { 
    background-color: #1e1e1e; 
    padding: 20px; 
    border-radius: 10px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
    width: 95%; 
    max-width: 500px; 
    animation: fadeIn 0.5s ease-out;
    display: none; 
    margin-top: 80px; 
    margin-bottom: 30px;
  }
  h2 { text-align:center; margin-bottom:25px; color: #ffffff; 
       border-bottom: 2px solid #007bff; padding-bottom: 10px; }
  
  .profile-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    background-color: #121212;
    border-radius: 8px;
    margin-bottom: 25px;
    width: 100%; 
  }
  .profile-details { display: flex; align-items: center; flex-wrap: wrap; }
  .profile-img {
    width: 60px; height: 60px;
    border-radius: 50%;
    margin-left: 15px;
    object-fit: cover;
    border: 3px solid #007bff;
    cursor: pointer; 
  }
  .profile-name { font-size: 1.3em; font-weight: bold; color: #fff; }
  .subscription-area {
      background-color: #121212;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center; 
      width: 100%; 
      display: flex;
      flex-direction: column;
      align-items: center;
  }
  
  .modal-content {
      background-color: #2a2a2a;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.7);
      width: 90%; 
      max-width: 450px; 
      text-align: right;
      position: relative;
      max-height: 85vh; 
      overflow-y: auto;   
  }
  
  .modal-overlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex; justify-content: center; align-items: center; z-index: 1000;
      opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
  }
  .modal-overlay.active { opacity: 1; visibility: visible; }

  .switch {
    --switch-width: 46px;
    --switch-height: 24px;
    --switch-bg: rgb(131, 131, 131);
    --switch-checked-bg: rgb(0, 218, 80);
    --switch-offset: calc((var(--switch-height) - var(--circle-diameter)) / 2);
    --switch-transition: all .2s cubic-bezier(0.27, 0.2, 0.25, 1.51);
    --circle-diameter: 18px;
    --circle-bg: #fff;
    --circle-shadow: 1px 1px 2px rgba(146, 146, 146, 0.45);
    --circle-checked-shadow: -1px 1px 2px rgba(163, 163, 163, 0.45);
    --circle-transition: var(--switch-transition);
    --icon-transition: all .2s cubic-bezier(0.27, 0.2, 0.25, 1.51);
    --icon-cross-color: var(--switch-bg);
    --icon-cross-size: 6px;
    --icon-checkmark-color: var(--switch-checked-bg);
    --icon-checkmark-size: 10px;
    --effect-width: calc(var(--circle-diameter) / 2);
    --effect-height: calc(var(--effect-width) / 2 - 1px);
    --effect-bg: var(--circle-bg);
    --effect-border-radius: 1px;
    --effect-transition: all .2s ease-in-out;
  }
  .switch input { display: none; }
  .switch { display: inline-block; }
  .switch svg {
    -webkit-transition: var(--icon-transition);
    -o-transition: var(--icon-transition);
    transition: var(--icon-transition);
    position: absolute;
    height: auto;
  }
  .switch .checkmark {
    width: var(--icon-checkmark-size);
    color: var(--icon-checkmark-color);
    -webkit-transform: scale(0);
    -ms-transform: scale(0);
    transform: scale(0);
  }
  .switch .cross {
    width: var(--icon-cross-size);
    color: var(--icon-cross-color);
  }
  .slider {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    width: var(--switch-width);
    height: var(--switch-height);
    background: var(--switch-bg);
    border-radius: 999px;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    position: relative;
    -webkit-transition: var(--switch-transition);
    -o-transition: var(--switch-transition);
    transition: var(--switch-transition);
    cursor: pointer;
  }
  .circle {
    width: var(--circle-diameter);
    height: var(--circle-diameter);
    background: var(--circle-bg);
    border-radius: inherit;
    -webkit-box-shadow: var(--circle-shadow);
    box-shadow: var(--circle-shadow);
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    -webkit-transition: var(--circle-transition);
    -o-transition: var(--circle-transition);
    transition: var(--circle-transition);
    z-index: 1;
    position: absolute;
    left: var(--switch-offset);
  }
  .slider::before {
    content: "";
    position: absolute;
    width: var(--effect-width);
    height: var(--effect-height);
    left: calc(var(--switch-offset) + (var(--effect-width) / 2));
    background: var(--effect-bg);
    border-radius: var(--effect-border-radius);
    -webkit-transition: var(--effect-transition);
    -o-transition: var(--effect-transition);
    transition: var(--effect-transition);
  }
  .switch input:checked+.slider { background: var(--switch-checked-bg); }
  .switch input:checked+.slider .checkmark {
    -webkit-transform: scale(1);
    -ms-transform: scale(1);
    transform: scale(1);
  }
  .switch input:checked+.slider .cross {
    -webkit-transform: scale(0);
    -ms-transform: scale(0);
    transform: scale(0);
  }
  .switch input:checked+.slider::before {
    left: calc(100% - var(--effect-width) - (var(--effect-width) / 2) - var(--switch-offset));
  }
  .switch input:checked+.slider .circle {
    left: calc(100% - var(--circle-diameter) - var(--switch-offset));
    -webkit-box-shadow: var(--circle-checked-shadow);
    box-shadow: var(--circle-checked-shadow);
  }

  .loader { /* ... (ŸÜŸÅÿ≥ ÿßŸÑŸÉŸàÿØ) ... */ }
  #toast-notification {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    width: 320px;
    padding: 12px;
    display: flex; 
    flex-direction: row;
    align-items: center;
    justify-content: start;
    border-radius: 8px;
    box-shadow: 0px 0px 10px -3px #111;
    position: fixed; 
    bottom: 20px; 
    left: 50%; 
    transform: translateX(-50%); 
    z-index: 2000; 
    transition: opacity 0.3s ease;
  }
  #toast-notification.success {
    background: #E0F2E9;
    border: 1px solid #28a745;
  }
  #toast-notification.success .toast-icon path { fill: #28a745; }
  #toast-notification.success .toast-title { color: #155724; }
  #toast-notification.success .toast-close path { fill: #155724; }
  #toast-notification.error {
    background: #FCE8DB;
    border: 1px solid #EF665B;
  }
  #toast-notification.error .toast-icon path { fill: #EF665B; }
  #toast-notification.error .toast-title { color: #71192F; }
  #toast-notification.error .toast-close path { fill: #71192F; }
  #toast-notification.warning {
    background: #FFF8E1;
    border: 1px solid #FFC107;
  }
  #toast-notification.warning .toast-icon path { fill: #FFC107; }
  #toast-notification.warning .toast-title { color: #856404; }
  #toast-notification.warning .toast-close path { fill: #856404; }
  .toast-icon {
    width: 20px;
    height: 20px;
    transform: translateY(-2px);
    margin-right: 8px;
    flex-shrink: 0; 
  }
  [dir="rtl"] .toast-icon { margin-right: 0; margin-left: 8px; }
  .toast-title {
    font-weight: 500;
    font-size: 14px;
    width: 100%; 
  }
  .toast-close {
    width: 20px;
    height: 20px;
    cursor: pointer;
    margin-left: auto;
    flex-shrink: 0; 
  }
  [dir="rtl"] .toast-close { margin-left: 0; margin-right: auto; }
  
  .Btn {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 45px;
    height: 45px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition-duration: .3s;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.199);
    background-color: rgb(255, 65, 65);
    margin-top: 25px; 
  }
  .Btn .sign {
    width: 100%;
    transition-duration: .3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .Btn .sign svg { width: 17px; }
  .Btn .sign svg path { fill: white; }
  .Btn .text {
    position: absolute;
    right: 0%;
    width: 0%;
    opacity: 0;
    color: white;
    font-size: 1em; 
    font-weight: 600;
    transition-duration: .3s;
  }
  [dir="rtl"] .Btn .text { right: auto; left: 0; }
  .Btn:hover {
    width: 130px; 
    border-radius: 40px;
    transition-duration: .3s;
  }
  .Btn:hover .sign {
    width: 30%;
    transition-duration: .3s;
    padding-left: 10px; 
  }
  [dir="rtl"] .Btn:hover .sign { padding-left: 0; padding-right: 10px; }
  .Btn:hover .text {
    opacity: 1;
    width: 70%;
    transition-duration: .3s;
    padding-right: 15px; 
  }
  [dir="rtl"] .Btn:hover .text { padding-right: 0; padding-left: 15px; }
  .Btn:active {
    transform: translate(2px ,2px);
  }
  
  .settings-card { 
    width: 100%; 
    background-color: rgba(36, 40, 50, 1);
    background-image: linear-gradient(
      139deg,
      rgba(36, 40, 50, 1) 0%,
      rgba(36, 40, 50, 1) 0%,
      rgba(37, 28, 40, 1) 100%
    );
    user-select: none;
    border-radius: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .settings-card .list {
    list-style-type: none;
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 0px;
    margin: 0;
  }
  .settings-card .separator {
    border-top: 1.5px solid #42434a;
    margin: 5px 0; 
  }
  .settings-card .list .element > a, 
  .settings-card .list .element > label {
    display: flex;
    align-items: center;
    color: #7e8590;
    gap: 10px;
    transition: all 0.3s ease-out;
    padding: 8px; 
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none; 
  }
  .settings-card .list .element label svg,
  .settings-card .list .element a svg,
  .settings-card .list .element a i { 
    width: 19px;
    height: 19px;
    transition: all 0.3s ease-out;
    stroke: #7e8590; 
    color: #7e8590; 
  }
  .settings-card .list .element label:hover,
  .settings-card .list .element a:hover { 
    background-color: var(--color);
    color: var(--hover-color);
  }
  .settings-card .list .element label:active,
  .settings-card .list .element a:active { 
    transform: scale(0.96);
  }
  .settings-card .list .element label:hover svg,
  .settings-card .list .element a:hover svg,
  .settings-card .list .element a:hover i { 
    stroke: var(--hover-storke);
    color: var(--hover-storke); 
  }

  .save-button {
    font-family: inherit;
    font-size: 18px; 
    background: #212121;
    color: white;
    fill: rgb(155, 153, 153);
    padding: 0.7em 1em;
    padding-left: 0.9em;
    display: flex;
    align-items: center;
    cursor: pointer;
    border: none;
    border-radius: 15px;
    font-weight: 1000;
    margin-top: 20px; 
  }
  .save-button span {
    display: block;
    margin-left: 0.3em;
    transition: all 0.3s ease-in-out;
  }
  [dir="rtl"] .save-button span { margin-left: 0; margin-right: 0.3em; }
  .save-button svg {
    display: block;
    transform-origin: center center;
    transition: transform 0.3s ease-in-out;
  }
  .save-button:hover { background: #000; }
  .save-button:hover .svg-wrapper {
    transform: scale(1.25);
    transition: 0.5s linear;
  }
  .save-button:hover svg {
    transform: translateX(1.2em) scale(1.1);
    fill: #fff;
  }
  [dir="rtl"] .save-button:hover svg { transform: translateX(-1.2em) scale(1.1); }
  .save-button:hover span {
    opacity: 0;
    transition: 0.5s linear;
  }
  .save-button:active { transform: scale(0.95); }
  .save-button:disabled { background: #444; cursor: not-allowed; } 

  .btn-cont {
    display: flex;
    justify-content: center;
    align-items: center;
    height: auto;
    background-color: transparent; 
    margin: 0;
    border: none; 
    border-radius: 10px;
  }
  .btn-cont .button {
    background: none;
    border: none;
    cursor: pointer;
    padding: 10px;
    border-radius: 5px;
    position: relative;
    transition: background-color 0.2s ease;
  }
  .btn-cont .button:hover { 
    background-color: rgba(255, 255, 255, 0.1);
  }
  .settings-btn {
    display: block;
    transition: transform 0.4s ease-in;
  }
  .settings-btn:hover {
    transform: rotate(60deg);
  }
  .tooltip { display: none; } 
  
  .modal-close-btn {
    position: absolute;
    top: 10px; 
    left: 15px; 
    background: none;
    border: none;
    font-size: 2em;
    color: #777;
    cursor: pointer;
    transition: color 0.2s;
    line-height: 1;
    padding: 5px;
  }
  .modal-close-btn:hover { color: #fff; }
  [dir="rtl"] .modal-close-btn { left: auto; right: 15px; } 
  
  .profile-pic-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 15px;
  }
  .profile-pic-container .profile-img { 
    margin-left: 0; 
    width: 80px; 
    height: 80px; 
  }
  .upload-pic-btn {
      display: inline-flex; 
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 15px;
      transition: background-color 0.2s;
      border: none; 
  }
  .upload-pic-btn:hover { background-color: #0056b3; }

  .modal-content input[type="text"],
  .modal-content input[type="email"],
  .modal-content textarea {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #555;
    background-color: #1e1e1e; 
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 1em;
    margin-top: 5px;
    box-sizing: border-box; 
  }
  .modal-content textarea {
    resize: vertical; 
    min-height: 80px;
  }
  .modal-content input:disabled,
  .modal-content input[disabled] { 
    background-color: #333 !important;
    color: #777 !important;
    opacity: 1; 
  }
  .modal-content label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
    color: #aaa;
  }
  
  #settings-form {
    display: flex;
    flex-direction: column;
  }
  #settings-form .save-button {
    margin-top: 25px;
    align-self: center; 
  }
  
  #notifications-settings-modal .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
  }
  #notifications-settings-modal .setting-row p { margin: 0; }
  #notifications-settings-modal .status-text {
      font-size: 0.9em;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
  }
  #notifications-settings-modal .status-text.subscribed {
      color: #155724; background-color: #d4edda;
  }
  #notifications-settings-modal .status-text.unsubscribed {
      color: #721c24; background-color: #f8d7da;
  }
  
  .confirm-modal-content {
      text-align: center;
  }
  .confirm-modal-content .icon {
      font-size: 3em;
      margin-bottom: 15px;
  }
  .confirm-modal-content .icon.warning { color: #fd7e14; }
  
  .confirm-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 25px;
  }
  .confirm-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.1s ease;
  }
  .confirm-btn.yes-btn { background-color: #dc3545; color: white; }
  .confirm-btn.no-btn { background-color: #6c757d; color: white; }
  .confirm-btn:active { transform: scale(0.95); }
  
  #delete-account-modal-step2 .user-email-display {
      background-color: #1e1e1e;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
      color: #fff;
  }
  #delete-account-modal-step2 input[type="email"] {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #555;
      background-color: #333;
      color: white;
      text-align: center;
  }
  #delete-account-modal-step2 .confirm-btn.delete-btn {
      background-color: #dc3545;
      color: white;
  }
  #delete-account-modal-step2 .confirm-btn.delete-btn:disabled {
      background-color: #555;
      cursor: not-allowed;
  }
  
  #profile-upload-modal h3 { margin-top: 15px; }
  #settings-modal .modal-content { padding: 0; }
  
  .cta-button { 
    padding: 10px 15px;
    background-color: #007bff;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 15px;
    transition: background-color 0.2s;
    border: none;
    text-decoration: none;
  }
  
  .modal-content h3 {
    padding: 0 30px; 
    margin-bottom: 20px;
    text-align: center; 
  }

.error {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  width: 100%; 
  padding: 12px;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: start;
  background: #EF665B; 
  border-radius: 8px;
  box-shadow: 0px 0px 5px -3px #111;
  margin-bottom: 20px; 
  transition: background-color 0.5s ease; 
}

.error.success-banner {
  background: #28a745; 
}

.error__icon {
  width: 20px;
  height: 20px;
  transform: translateY(-2px);
  margin-right: 8px;
  flex-shrink: 0;
}
[dir="rtl"] .error__icon {
    margin-right: 0;
    margin-left: 8px;
}

.error__icon path {
  fill: #fff;
}

.error__title {
  font-weight: 500;
  font-size: 14px;
  color: #fff;
  flex-grow: 1; 
}

#resend-email-btn {
  background: #fff;
  color: #EF665B;
  border: none;
  border-radius: 5px;
  padding: 5px 10px;
  font-weight: bold;
  cursor: pointer;
  margin-left: auto; 
  flex-shrink: 0;
  transition: background 0.2s, color 0.2s;
  white-space: nowrap; 
}
[dir="rtl"] #resend-email-btn {
    margin-left: 0;
    margin-right: auto;
}

#resend-email-btn:hover {
    background: #f0f0f0;
}

#resend-email-btn:disabled {
  background: #aaa;
  color: #777;
  cursor: not-allowed;
}

.error.success-banner #resend-email-btn {
    background: #fff;
    color: #28a745;
}
</style>

<script type="module">
    
    // --- IMPORTS (MUST BE AT TOP LEVEL) ---
    // * ‚¨ÖÔ∏è ŸÇŸÖŸÜÿß ÿ®ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ¨ÿßŸáÿ≤ÿ© ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
    import { app, database, auth } from '/rool/boomb/erdg/xoxo/Catchmeifyoucan/firebase-init.js';
    
    // * ‚¨ÖÔ∏è ŸÇŸÖŸÜÿß ÿ®ÿ≠ÿ∞ŸÅ (initializeApp, getAuth, getDatabase) ŸÑÿ£ŸÜŸáÿß ÿ£ÿµÿ®ÿ≠ÿ™ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
    import { signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail, deleteUser, sendEmailVerification } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { get, ref, update, child, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // --- FIREBASE CONFIG (TOP LEVEL) ---
    // * ‚¨ÖÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸÑÿ£ŸÜŸá ÿ£ÿµÿ®ÿ≠ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
    // const firebaseConfig = { ... };
    // const app = initializeApp(firebaseConfig);
    // const auth = getAuth(app);
    // const db = getDatabase(app);

    const IMGBB_API_KEY = "f0ff703738276bb67fcc6b7f0a6778d5";

    // --- GLOBAL VARS (TOP LEVEL) ---
    let currentLang = 'ar'; 
    let currentUser = null;
    let isSubscribed = false;
    let isWebPushSubscribed = false; 
    let lastProfileUpdate = 0;
    let lastSubChange = 0;
    let lastWebPushSubChange = 0; 
    const UPDATE_RATE_LIMIT = 24 * 60 * 60 * 1000;
    const SUB_COOLDOWN = 5 * 60 * 1000;
    let toastTimer; 
    let isDeletePending = false; 
    let lastVerificationEmailTime = 0;
    let cooldownTimer = null;

    // --- TRANSLATIONS (TOP LEVEL) ---
    const translations = {
      "ar": {
          "pageTitle": "SkyData - ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
          "profileTitle": "ÿßŸÑŸÄŸÖŸÑŸÅ ÿßŸÑŸÄÿ¥ÿÆÿµŸä", 
          "notifTitle": "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸàÿßŸÑÿ®ÿ±ŸäÿØ",
          "subStatus": "ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:",
          "subYes": "ŸÖÿ¥ÿ™ÿ±ŸÉ: ÿ™ÿµŸÑŸÉ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ™ÿ≥ŸàŸäŸÇŸä ŸàÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™",
          "subNo": "ÿ∫Ÿäÿ± ŸÖÿ¥ÿ™ÿ±ŸÉ: ŸÑÿß ÿ™ÿµŸÑŸÉ ÿ£Ÿä ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿ±ŸäÿØ ÿ™ÿ≥ŸàŸäŸÇŸä",
          "logoutBtn": "ÿÆÿ±Ÿàÿ¨", 
          "settingsTitle": "ÿ•ÿπÿØÿßÿØÿßÿ™",
          "settingsMenuProfile": "ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä",
          "settingsMenuNotifications": "ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™",
          "settingsMenuSupport": "ÿßŸÑÿØÿπŸÖ",
          "settingsMenuDelete": "ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
          "profileSettingsTitle": "ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä",
          "profileChangePic": "ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©",
          "profileBioLabel": "ŸÜÿ®ÿ∞ÿ© ÿπŸÜŸä",
          "profileBioPlaceholder": "ÿßŸÉÿ™ÿ® ÿ¥Ÿäÿ¶ÿßŸã ÿπŸÜ ŸÜŸÅÿ≥ŸÉ...",
          "notifModalTitle": "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™",
          "notifModalEmailHeader": "ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
          "notifModalEmailText": "ÿ•ÿØÿßÿ±ÿ© ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ™ÿ≥ŸàŸäŸÇŸä ŸàÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™.",
          "notifModalWebHeader": "ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ (Web Push)",
          "notifModalWebText": "ÿ™ŸÑŸÇŸä ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ŸÅŸàÿ±Ÿäÿ© ŸÖŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.",
          "notifStatusLabel": "ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:",
          "notifStatusSubbed": "ŸÖÿ¥ÿ™ÿ±ŸÉ",
          "notifStatusUnsubbed": "ÿ∫Ÿäÿ± ŸÖÿ¥ÿ™ÿ±ŸÉ",
          "logoutConfirmTitle": "ÿ™ÿ£ŸÉŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
          "logoutConfirmText": "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü",
          "confirmYes": "ŸÜÿπŸÖ",
          "confirmNo": "ŸÑÿß",
          "deleteModalTitle1": "ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
          "deleteModalText1": "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ®ŸÉÿü ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÜŸáÿßÿ¶ŸäÿßŸã. ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:",
          "deleteModalTitle2": "ÿ™ÿ£ŸÉŸäÿØ ŸÜŸáÿßÿ¶Ÿä",
          "deleteModalText2": "ŸÑÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ®ŸÉÿå Ÿäÿ±ÿ¨Ÿâ ŸÉÿ™ÿßÿ®ÿ© ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ ÿ£ÿØŸÜÿßŸá. Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.",
          "deleteModalPlaceholder": "ÿßŸÉÿ™ÿ® ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸÑÿ™ÿ£ŸÉŸäÿØ",
          "deleteModalConfirmBtn": "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ",
          "deleteInProgress": "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ∞ŸÅ...",
          "deleteSuccess": "ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠. ÿ¨ÿßÿ±Ÿä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨...",
          "subYesToast": "ÿ™ŸÖ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!",
          "subNoToast": "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ.",
          "cooldownMsg": "Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± 5 ÿØŸÇÿßÿ¶ŸÇ ŸÇÿ®ŸÑ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",
          "noName": "ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ",
          "profileUploadTitle": "ÿ±ŸÅÿπ ÿµŸàÿ±ÿ™ŸÉ ÿßŸÑÿ¥ÿÆÿµŸäÿ©",
          "uploading": "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ŸÅÿπ... Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±",
          "uploadSuccess": "ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ ÿ®ŸÜÿ¨ÿßÿ≠!",
          "uploadError": "ŸÅÿ¥ŸÑ ÿßŸÑÿ±ŸÅÿπ. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ŸàŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ",
          "settingsPassTitle": "ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
          "settingsPassText": "ŸÑÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±ÿå ÿ≥ŸÜÿ±ÿ≥ŸÑ ÿ±ÿßÿ®ÿ∑ÿßŸã ÿπŸÑŸâ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
          "settingsPassBtn": "ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
          "settingsSaveBtn": "ÿ≠ŸÅÿ∏", 
          "settingsSuccess": "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠",
          "settingsEmailSent": "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿ•ŸÑŸâ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
          "rateLimitMsg": "ŸäŸÖŸÉŸÜŸÉ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿ£Ÿà ÿßŸÑÿßÿ≥ŸÖ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÉŸÑ 24 ÿ≥ÿßÿπÿ©. Ÿäÿ™ÿ®ŸÇŸâ {hours} ÿ≥ÿßÿπÿ© Ÿà {minutes} ÿØŸÇŸäŸÇÿ©",
          "verifyEmailWarning": "ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ŸÖŸèŸÅÿπŸëŸÑ. ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ŸÅÿπŸäŸÑ. (ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿπÿ¥Ÿàÿßÿ¶Ÿä)",
          "resendButton": "ÿ•ÿπÿßÿØÿ© ÿ•ÿ±ÿ≥ÿßŸÑ",
          "resendButtonCooldown": "ÿßŸÜÿ™ÿ∏ÿ± {seconds} ÿ´",
          "verificationSent": "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿßÿ®ÿ∑! ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ÿ±ŸäÿØŸÉ.",
      },
      "en": {
          "pageTitle": "SkyData - Home",
          "profileTitle": "Profile", 
          "notifTitle": "Manage Notifications & Email",
          "subStatus": "Subscription Status:",
          "subYes": "Subscribed: You will receive marketing emails and updates",
          "subNo": "Unsubscribed: You will not receive any marketing emails",
          "logoutBtn": "Logout", 
          "settingsTitle": "Settings",
          "settingsMenuProfile": "Profile",
          "settingsMenuNotifications": "Notifications",
          "settingsMenuSupport": "Support",
          "settingsMenuDelete": "Delete Account",
          "profileSettingsTitle": "Edit Profile",
          "profileChangePic": "Change Picture",
          "profileBioLabel": "About Me",
          "profileBioPlaceholder": "Write something about yourself...",
          "notifModalTitle": "Notification Management",
          "notifModalEmailHeader": "Email Notifications",
          "notifModalEmailText": "Manage marketing emails and updates.",
          "notifModalWebHeader": "Web Push Notifications",
          "notifModalWebText": "Receive instant browser alerts.",
          "notifStatusLabel": "Subscription Status:",
          "notifStatusSubbed": "Subscribed",
          "notifStatusUnsubbed": "Unsubscribed",
          "logoutConfirmTitle": "Confirm Logout",
          "logoutConfirmText": "Are you sure you want to log out?",
          "confirmYes": "Yes",
          "confirmNo": "No",
          "deleteModalTitle1": "Confirm Account Deletion",
          "deleteModalText1": "Are you sure you want to delete your account? All your data will be permanently removed. Your email:",
          "deleteModalTitle2": "Final Confirmation",
          "deleteModalText2": "To delete your account, please type your email below. This action cannot be undone.",
          "deleteModalPlaceholder": "Type your email to confirm",
          "deleteModalConfirmBtn": "Confirm Deletion",
          "deleteInProgress": "Deleting...",
          "deleteSuccess": "Account deleted successfully. Logging out...",
          "subYesToast": "Subscribed successfully!",
          "subNoToast": "Unsubscribed.",
          "cooldownMsg": "Please wait 5 minutes before changing your subscription status again.",
          "noName": "New User",
          "profileUploadTitle": "Upload Your Profile Picture",
          "uploading": "Uploading... Please wait",
          "uploadSuccess": "Upload successful!",
          "uploadError": "Upload failed. Please check file size/type",
          "settingsPassTitle": "Change Password",
          "settingsPassText": "To change your password, we will send a reset link to your email",
          "settingsPassBtn": "Send Password Reset Link",
          "settingsSaveBtn": "Save", 
          "settingsSuccess": "Changes saved successfully",
          "settingsEmailSent": "Password reset link sent to your email",
          "rateLimitMsg": "You can only change your profile picture or name once every 24 hours. Remaining: {hours}h {minutes}m",
          "verifyEmailWarning": "Your email is not verified. Click to send activation link. (Check spam folder)",
          "resendButton": "Resend",
          "resendButtonCooldown": "Wait {seconds}s",
          "verificationSent": "Link sent! Check your email.",
      }
    };

    // --- HELPER FUNCTIONS (TOP LEVEL) ---
    async function getSubscription(uid) {
        const dbRef = ref(db);
        try {
            const snapshot = await get(child(dbRef, `users/${uid}`));
            if (snapshot.exists()) {
                const data = snapshot.val();
                return {
                    emailSub: data.subscribe_marketing === true,
                    webPushSub: data.subscribe_webpush === true, 
                    bio: data.bio || "", 
                    lastProfileUpdate: data.lastUpdated || 0,
                    lastSubChange: data.lastSubChange || 0,
                    lastWebPushSubChange: data.lastWebPushSubChange || 0 
                };
            } else {
                return { emailSub: false, webPushSub: false, bio: "", lastProfileUpdate: 0, lastSubChange: 0, lastWebPushSubChange: 0 };
            }
        } catch (error) {
            console.error("Error getting user data:", error);
            return { emailSub: false, webPushSub: false, bio: "", lastProfileUpdate: 0, lastSubChange: 0, lastWebPushSubChange: 0 };
        }
    }

    function updateUserProfileDB(uid, data) {
      update(ref(db, 'users/' + uid), data);
    }

    async function checkImageSafety(base64Image) {
        return { safe: true }; // Mock
    }
    
    function formatTimeRemaining(ms) {
        const hours = Math.floor(ms / (1000 * 60 * 60));
        const minutes = Math.ceil((ms % (1000 * 60 * 60)) / (1000 * 60));
        return { hours, minutes };
    }

    // --- üÜï WRAP DOM-DEPENDENT CODE ---
    document.addEventListener('DOMContentLoaded', () => {

        // --- DOM ELEMENT VARIABLES ---
        const contentContainer = document.getElementById('contentContainer');
        const loaderContainer = document.getElementById('loaderContainer');
        const profileImgEl = document.getElementById('profile-img');
        const profileNameEl = document.getElementById('profile-name');
        const userEmailEl = document.getElementById('userEmail');
        const currentSubscriptionEl = document.getElementById('currentSubscription');
        const settingsBtn = document.getElementById('settings-btn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // (Modals)
        const profileModal = document.getElementById('profile-upload-modal');
        const settingsModal = document.getElementById('settings-modal'); 
        const profileSettingsModal = document.getElementById('profile-settings-modal'); 
        const notifModal = document.getElementById('notifications-settings-modal'); 
        const logoutConfirmModal = document.getElementById('logout-confirm-modal'); 
        const deleteModalStep1 = document.getElementById('delete-account-modal-step1'); 
        const deleteModalStep2 = document.getElementById('delete-account-modal-step2'); 

        // (Profile Upload Modal)
        const uploadImageInput = document.getElementById('upload-image-input');
        const modalStatus = document.getElementById('modal-status');
        const modalSpinner = document.getElementById('modal-spinner');

        // (Profile Settings Modal)
        const settingsForm = document.getElementById('settings-form');
        const settingsNameInput = document.getElementById('settings-display-name');
        const settingsBioInput = document.getElementById('settings-bio'); 
        const settingsEmailDisplay = document.getElementById('settings-email-display'); 
        const settingsRateLimit = document.getElementById('settings-rate-limit');
        const settingsStatus = document.getElementById('settings-status');
        const settingsSpinner = document.getElementById('settings-spinner');
        const profileChangePicBtn = document.getElementById('profile-change-pic-btn'); 
        const profileImgPreview = document.getElementById('profile-img-preview'); 

        // (Notifications Modal)
        const emailSubToggle = document.getElementById('email-sub-toggle'); 
        const webPushToggle = document.getElementById('web-push-toggle'); 
        const emailStatusText = document.getElementById('email-status-text'); 
        const webPushStatusText = document.getElementById('web-push-status-text'); 

        // (Logout Confirm Modal)
        const logoutConfirmYes = document.getElementById('logout-confirm-yes'); 
        const logoutConfirmNo = document.getElementById('logout-confirm-no'); 
        
        // (Delete Account Modals)
        const deleteEmailDisplay1 = document.getElementById('delete-email-display-1'); 
        const deleteConfirmYes = document.getElementById('delete-confirm-yes'); 
        const deleteConfirmNo = document.getElementById('delete-confirm-no'); 
        const deleteEmailDisplay2 = document.getElementById('delete-email-display-2'); 
        const deleteEmailInput = document.getElementById('delete-email-input'); 
        const deleteConfirmFinalBtn = document.getElementById('delete-confirm-final-btn'); 
        const deleteStatus = document.getElementById('delete-status'); 

        // (Toast Notification)
        const toastEl = document.getElementById('toast-notification');
        const toastTitle = document.getElementById('toast-title');
        const toastClose = document.getElementById('toast-close');

        // --- DOM-DEPENDENT FUNCTIONS ---

        function showToast(message, type = 'success') {
            if (toastTimer) clearTimeout(toastTimer);
            toastTitle.textContent = message;
            toastEl.className = '';
            toastEl.classList.add(type);
            toastEl.style.display = 'flex';
            toastTimer = setTimeout(() => {
                toastEl.style.display = 'none';
            }, 4000);
        }

        function updateHomeSubscriptionUI(subscribed) {
            isSubscribed = subscribed;
            currentSubscriptionEl.textContent = subscribed ? translations[currentLang].subYes : translations[currentLang].subNo;
            currentSubscriptionEl.className = subscribed ? 'subscription-status' : 'subscription-status unsubscribed';
        }
        
        function updateNotifStatusUI(emailSub, webPushSub) {
            emailSubToggle.checked = emailSub;
            webPushToggle.checked = webPushSub;
            
            emailStatusText.textContent = emailSub ? translations[currentLang].notifStatusSubbed : translations[currentLang].notifStatusUnsubbed;
            emailStatusText.className = emailSub ? 'status-text subscribed' : 'status-text unsubscribed';

            webPushStatusText.textContent = webPushSub ? translations[currentLang].notifStatusSubbed : translations[currentLang].notifStatusUnsubbed;
            webPushStatusText.className = webPushSub ? 'status-text subscribed' : 'status-text unsubscribed';
        }
        
        window.setLanguage = function(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
            
            document.getElementById('lang-ar').classList.toggle('active', lang === 'ar');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');

            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[currentLang][key]) {
                    const translationText = translations[currentLang][key];
                    if (element.id === 'settings-save-btn' && element.classList.contains('save-button')) {
                        element.querySelector('span').textContent = translationText;
                    } 
                    else if (element.id === 'logoutBtn' && element.classList.contains('Btn')) {
                        element.querySelector('.text').textContent = translationText;
                    }
                    else {
                        element.innerHTML = translationText;
                    }
                }
            });
            
            if (currentUser) {
                profileNameEl.textContent = currentUser.displayName || translations[currentLang].noName;
                updateHomeSubscriptionUI(isSubscribed);
                updateNotifStatusUI(isSubscribed, isWebPushSubscribed);
            }

            const verificationBanner = document.getElementById('email-verification-banner');
            if (verificationBanner.style.display === 'flex') {
            
                if (verificationBanner.classList.contains('success-banner')) {
                    document.getElementById('verification-message').innerHTML = translations[currentLang].verificationSent;
                } else {
                    document.getElementById('verification-message').innerHTML = translations[currentLang].verifyEmailWarning;
                }
            
                const resendBtn = document.getElementById('resend-email-btn');
                if (!resendBtn.disabled) {
                    resendBtn.innerHTML = translations[currentLang].resendButton;
                }
            }
        }

        async function uploadProfilePicture(file) {
            modalStatus.textContent = '';
            modalSpinner.style.display = 'block';

            try {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(resolve => reader.onload = resolve);
                const base64Image = reader.result.split(',')[1];
                
                modalStatus.textContent = translations[currentLang].uploading;
                const safetyCheck = await checkImageSafety(base64Image); 
                if (!safetyCheck.safe) {
                    modalStatus.textContent = translations[currentLang].moderationError;
                    return;
                }
                
                const formData = new FormData();
                formData.append('key', IMGBB_API_KEY);
                formData.append('image', base64Image);

                const uploadResponse = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData,
                });

                const result = await uploadResponse.json();

                if (result.success && currentUser) {
                    const photoURL = result.data.url;
                    await updateProfile(currentUser, { photoURL });
                    updateUserProfileDB(currentUser.uid, { photoURL: photoURL }); 
                    
                    profileImgEl.src = photoURL;
                    profileImgPreview.src = photoURL; 
                    profileImgEl.classList.remove('default');
                    profileImgPreview.classList.remove('default'); 
                    
                    modalStatus.textContent = translations[currentLang].uploadSuccess;
                    setTimeout(() => { 
                        profileModal.classList.remove('active'); 
                        profileSettingsModal.classList.add('active'); 
                    }, 1500);
                } else {
                    modalStatus.textContent = translations[currentLang].uploadError;
                }
            } catch (error) {
                console.error("Upload process failed:", error);
                modalStatus.textContent = translations[currentLang].uploadError;
            } finally {
                modalSpinner.style.display = 'none';
            }
        }

        function populateProfileForm(userData) {
            settingsStatus.style.display = 'none';
            settingsNameInput.value = currentUser.displayName || '';
            settingsEmailDisplay.textContent = currentUser.email || '';
            settingsBioInput.value = userData.bio || ''; 
            profileImgPreview.src = currentUser.photoURL || 'https://i.ibb.co/6y45s1f/default.webp'; 
            
            const timeElapsed = Date.now() - userData.lastProfileUpdate;
            if (timeElapsed < UPDATE_RATE_LIMIT) {
                const remaining = formatTimeRemaining(UPDATE_RATE_LIMIT - timeElapsed);
                settingsRateLimit.innerHTML = translations[currentLang].rateLimitMsg
                    .replace('{hours}', remaining.hours)
                    .replace('{minutes}', remaining.minutes);
                settingsRateLimit.style.display = 'block';
                settingsNameInput.disabled = true;
                settingsBioInput.disabled = true; 
                settingsForm.querySelector('#settings-save-btn').disabled = true;
            } else {
                settingsRateLimit.style.display = 'none';
                settingsNameInput.disabled = false;
                settingsBioInput.disabled = false; 
                settingsForm.querySelector('#settings-save-btn').disabled = false;
            }
        }

        // --- EVENT LISTENERS ---
        toastClose.addEventListener('click', () => {
            if (toastTimer) clearTimeout(toastTimer);
            toastEl.style.display = 'none';
        });

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            settingsSpinner.style.display = 'block';
            settingsStatus.style.display = 'none';
            const newName = settingsNameInput.value.trim();
            const newBio = settingsBioInput.value.trim(); 
            const newLastUpdated = Date.now();
            
            let profileDataChanged = false;
            let dbDataChanged = false;
            
            try {
                if (newName !== currentUser.displayName) {
                    await updateProfile(currentUser, { displayName: newName });
                    profileNameEl.textContent = newName;
                    profileDataChanged = true;
                }
                
                const dbUpdates = {};
                if (profileDataChanged) {
                    dbUpdates.lastUpdated = newLastUpdated;
                    dbDataChanged = true;
                }
                
                dbUpdates.bio = newBio;
                dbDataChanged = true; 
                
                if (dbDataChanged) {
                    updateUserProfileDB(currentUser.uid, dbUpdates);
                    lastProfileUpdate = newLastUpdated;
                }
                
                settingsStatus.textContent = translations[currentLang].settingsSuccess;
                settingsStatus.style.color = '#28a745';
                settingsStatus.style.display = 'block';
                
                setTimeout(() => { profileSettingsModal.classList.remove('active'); }, 1500);

            } catch (error) {
                settingsStatus.textContent = `Error: ${error.message}`;
                settingsStatus.style.color = '#dc3545';
                settingsStatus.style.display = 'block';
            } finally {
                settingsSpinner.style.display = 'none';
            }
        });

        document.getElementById('reset-password-btn').addEventListener('click', async () => {
             // ... (ŸÜŸÅÿ≥ ÿßŸÑŸÉŸàÿØ)
        });

        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUser = user;
                
                const verificationBanner = document.getElementById('email-verification-banner');
                const verificationMessage = document.getElementById('verification-message');
                const resendBtn = document.getElementById('resend-email-btn');

                if (!user.emailVerified) {
                    verificationBanner.style.display = 'flex';
                    verificationMessage.innerHTML = translations[currentLang].verifyEmailWarning;

                    resendBtn.onclick = () => {
                        const now = Date.now();
                        if (now - lastVerificationEmailTime < SUB_COOLDOWN) {
                            showToast(translations[currentLang].cooldownMsg, 'warning');
                            return;
                        }

                        sendEmailVerification(user)
                            .then(() => {
                                lastVerificationEmailTime = Date.now();
                                verificationBanner.classList.add('success-banner');
                                verificationMessage.innerHTML = translations[currentLang].verificationSent;
                                resendBtn.disabled = true;

                                let secondsLeft = SUB_COOLDOWN / 1000;
                                resendBtn.innerHTML = translations[currentLang].resendButtonCooldown.replace('{seconds}', secondsLeft);

                                if(cooldownTimer) clearInterval(cooldownTimer);
                                cooldownTimer = setInterval(() => {
                                    secondsLeft--;
                                    if (secondsLeft > 0) {
                                        resendBtn.innerHTML = translations[currentLang].resendButtonCooldown.replace('{seconds}', secondsLeft);
                                    } else {
                                        clearInterval(cooldownTimer);
                                        resendBtn.disabled = false;
                                        resendBtn.innerHTML = translations[currentLang].resendButton;
                                    }
                                }, 1000);

                                setTimeout(() => {
                                    verificationBanner.style.display = 'none';
                                    verificationBanner.classList.remove('success-banner'); 
                                }, 30000); 

                            })
                            .catch((error) => {
                                showToast(`Error: ${error.message}`, 'error');
                            });
                    };

                } else {
                    verificationBanner.style.display = 'none';
                }

                const userData = await getSubscription(user.uid);

                isSubscribed = userData.emailSub;
                isWebPushSubscribed = userData.webPushSub; 
                lastProfileUpdate = userData.lastProfileUpdate;
                lastSubChange = userData.lastSubChange; 
                lastWebPushSubChange = userData.lastWebPushSubChange; 
                
                window.setLanguage(currentLang); 
                
                profileNameEl.textContent = user.displayName || translations[currentLang].noName;
                userEmailEl.textContent = user.email; 
                profileImgEl.src = user.photoURL || 'https://i.ibb.co/6y45s1f/default.webp';
                if (!user.photoURL) profileImgEl.classList.add('default');

                updateHomeSubscriptionUI(isSubscribed);
                updateNotifStatusUI(isSubscribed, isWebPushSubscribed); 
                
                populateProfileForm(userData);
                deleteEmailDisplay1.textContent = user.email;
                deleteEmailDisplay2.textContent = user.email;

                loaderContainer.style.display = 'none';
                contentContainer.style.display = 'block';
                
            } else {
                // * ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ´ÿßŸÜŸä ŸáŸÜÿß ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è *
                // * ‚¨ÖÔ∏è ŸäŸÖŸÜÿπŸÉ ŸÖŸÜ ÿßŸÑÿπŸàÿØÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®ÿπÿØ ÿßŸÑÿÆÿ±Ÿàÿ¨
                window.location.replace("login.html"); 
                // * ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è ŸÜŸáÿßŸäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è *
            }
        });

        // 1. (ÿ≤ÿ± ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ - ÿßŸÑÿ™ÿ±ÿ≥)
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
        });
        
        // 2. (ÿ£ÿ≤ÿ±ÿßÿ± ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©)
        document.getElementById('settings-menu-profile').addEventListener('click', (e) => {
            e.preventDefault();
            settingsModal.classList.remove('active'); 
            profileSettingsModal.classList.add('active'); 
        });
        
        document.getElementById('settings-menu-notifications').addEventListener('click', (e) => {
            e.preventDefault();
            settingsModal.classList.remove('active'); 
            notifModal.classList.add('active'); 
        });

        document.getElementById('settings-menu-support').addEventListener('click', (e) => {
            e.preventDefault();
            window.open('Support.html', '_blank'); 
        });

        document.getElementById('settings-menu-delete').addEventListener('click', (e) => {
            e.preventDefault();
            settingsModal.classList.remove('active'); 
            deleteModalStep1.classList.add('active'); 
        });
        
        // 3. (ÿ£ÿ≤ÿ±ÿßÿ± ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©)
        profileImgEl.addEventListener('click', () => {
            profileModal.classList.add('active');
        });
        profileChangePicBtn.addEventListener('click', () => {
            profileSettingsModal.classList.remove('active');
            profileModal.classList.add('active');
        });
        document.getElementById('upload-profile-btn').addEventListener('click', () => {
          uploadImageInput.click();
        });
        uploadImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) { uploadProfilePicture(file); }
        });
        
        // 4. (ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿ®ÿßŸÑÿÆŸÑŸÅŸäÿ©)
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    overlay.classList.remove('active');
                }
            });
        });

        // 5. (ÿ¨ÿØŸäÿØ: ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿ®ÿßŸÑÿ≤ÿ± X)
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.modal-overlay').classList.remove('active');
            });
        });

        // 6. (ÿ£ÿ≤ÿ±ÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™)
        emailSubToggle.addEventListener('change', async (e) => {
            if (!currentUser) return;
            const timeSinceLastChange = Date.now() - lastSubChange;
            
            if (timeSinceLastChange < SUB_COOLDOWN) {
                e.target.checked = !e.target.checked; 
                showToast(translations[currentLang].cooldownMsg, 'warning');
                return;
            }

            const newSubState = e.target.checked;
            const newLastSubChange = Date.now();
            
            try {
                await updateUserProfileDB(currentUser.uid, { 
                    subscribe_marketing: newSubState,
                    lastSubChange: newLastSubChange
                });
                lastSubChange = newLastSubChange;
                updateHomeSubscriptionUI(newSubState); 
                updateNotifStatusUI(newSubState, isWebPushSubscribed); 
                
                showToast(
                    newSubState ? translations[currentLang].subYesToast : translations[currentLang].subNoToast,
                    newSubState ? 'success' : 'error'
                );
            } catch (error) {
                e.target.checked = !e.target.checked; 
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        webPushToggle.addEventListener('change', async (e) => {
            if (!currentUser) return;
            const timeSinceLastChange = Date.now() - lastWebPushSubChange;
            
            if (timeSinceLastChange < SUB_COOLDOWN) {
                e.target.checked = !e.target.checked; 
                showToast(translations[currentLang].cooldownMsg, 'warning');
                return;
            }
            
            const newSubState = e.target.checked;
            const newLastWebPushSubChange = Date.now();
            
            try {
                await updateUserProfileDB(currentUser.uid, { 
                    subscribe_webpush: newSubState,
                    lastWebPushSubChange: newLastWebPushSubChange
                });
                lastWebPushSubChange = newLastWebPushSubChange;
                isWebPushSubscribed = newSubState; 
                updateNotifStatusUI(isSubscribed, newSubState);
                
                showToast(
                    newSubState ? translations[currentLang].subYesToast : translations[currentLang].subNoToast,
                    newSubState ? 'success' : 'error'
                );
            } catch (error) {
                e.target.checked = !e.target.checked; 
                showToast(`Error: ${error.message}`, 'error');
            }
        });
        
        // 7. (ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿßŸÑÿ¨ÿØŸäÿØ)
        logoutBtn.addEventListener('click', () => {
            logoutConfirmModal.classList.add('active');
        });
        logoutConfirmYes.addEventListener('click', () => {
            signOut(auth).catch((error) => {
                console.error("Sign out error", error);
                showToast(`Sign out error: ${error.message}`, 'error');
            });
        });
        logoutConfirmNo.addEventListener('click', () => {
            logoutConfirmModal.classList.remove('active');
        });

        // 8. (ÿ£ÿ≤ÿ±ÿßÿ± ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®)
        deleteConfirmYes.addEventListener('click', () => {
            deleteModalStep1.classList.remove('active');
            deleteModalStep2.classList.add('active');
        });
        deleteConfirmNo.addEventListener('click', () => {
            deleteModalStep1.classList.remove('active');
        });
        
        deleteEmailInput.addEventListener('input', () => {
            if (deleteEmailInput.value === currentUser.email) {
                deleteConfirmFinalBtn.disabled = false;
            } else {
                deleteConfirmFinalBtn.disabled = true;
            }
        });
        
        deleteConfirmFinalBtn.addEventListener('click', async () => {
            if (isDeletePending || deleteEmailInput.value !== currentUser.email) return;

            isDeletePending = true;
            deleteConfirmFinalBtn.disabled = true;
            deleteStatus.textContent = translations[currentLang].deleteInProgress;
            deleteStatus.style.display = 'block';

            try {
                await remove(ref(db, 'users/' + currentUser.uid));
                
                await deleteUser(currentUser);
                
                showToast(translations[currentLang].deleteSuccess, 'success');
                
            } catch (error) {
                console.error("Delete account error:", error);
                if (error.code === 'auth/requires-recent-login') {
                    showToast('Please log out and log back in to delete your account.', 'error');
                } else {
                    showToast(`Error: ${error.message}`, 'error');
                }
                deleteStatus.style.display = 'none';
                isDeletePending = false;
                deleteConfirmFinalBtn.disabled = false;
            }
        });


        // --- INITIAL CALL ---
        window.setLanguage(currentLang); 
    
    }); // --- END OF DOMCONTENTLOADED ---
</script>
</head>
<body>
    <div class="loader" id="loaderContainer">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>

    <header>
        <div class="logo-container">
            <img src="https://i.ibb.co/hJ2nq38z/clouddata.webp" alt="ÿ¥ÿπÿßÿ± CloudData">
            <img src="https://i.ibb.co/v9zLrFg/skydata.webp" alt="ÿ¥ÿπÿßÿ± Skydata">
        </div>
        
        <div class="lang-switcher">
            <a href="#" id="lang-ar" class="active" onclick="setLanguage('ar'); return false;">AR</a>
            <a href="#" id="lang-en" onclick="setLanguage('en'); return false;">EN</a>
        </div>
    </header>


    <div class="container" id="contentContainer" style="margin-top: 80px;">
     <div class="error" id="email-verification-banner" style="display: none;">
    <div class="error__icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" height="24" fill="none"><path fill="#fff" d="m13 13h-2v-6h2zm0 4h-2v-2h2zm-1-15c-1.3132 0-2.61358.25866-3.82683.7612-1.21326.50255-2.31565 1.23915-3.24424 2.16773-1.87536 1.87537-2.92893 4.41891-2.92893 7.07107 0 2.6522 1.05357 5.1957 2.92893 7.0711.92859.9286 2.03098 1.6651 3.24424 2.1677 1.21325.5025 2.51363.7612 3.82683.7612 2.6522 0 5.1957-1.0536 7.0711-2.9289 1.8753-1.8754 2.9289-4.4189 2.9289-7.0711 0-1.3132-.2587-2.61358-.7612-3.82683-.5026-1.21326-1.2391-2.31565-2.1677-3.24424-.9286-.92858-2.031-1.66518-3.2443-2.16773-1.2132-.50254-2.5136-.7612-3.8268-.7612z"></path></svg>
    </div>
    <div class="error__title" id="verification-message" data-lang-key="verifyEmailWarning">
        ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ŸÖŸèŸÅÿπŸëŸÑ.
    </div>
    <button id="resend-email-btn" data-lang-key="resendButton">ÿ•ÿπÿßÿØÿ© ÿ•ÿ±ÿ≥ÿßŸÑ</button>
</div>
      <h2 data-lang-key="profileTitle">ÿßŸÑŸÄŸÖŸÑŸÅ ÿßŸÑŸÄÿ¥ÿÆÿµŸä</h2>
      
      <div class="profile-info">
        <div class="profile-details">
          <img id="profile-img" src="https://i.ibb.co/6y45s1f/default.webp" alt="Profile Picture" class="profile-img default">
          <div>
            <div class="profile-name" id="profile-name"></div>
            <div class="user-email" id="userEmail" style="font-size: 0.9em; color: #aaa;"></div>
          </div>
        </div>
        <div class="btn-cont">
          <button class="button" id="settings-btn">
            <svg
              class="settings-btn"
              xmlns="http://www.w3.org/2000/svg"
              height="24"
              viewBox="0 -960 960 960"
              width="24"
              fill="#e8eaed"
            >
              <path
                d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="subscription-area">
        <h3 data-lang-key="notifTitle">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸàÿßŸÑÿ®ÿ±ŸäÿØ</h3>
        <p class="subscription-status" id="currentSubscription"></p>
        
        <button class="Btn" id="logoutBtn" data-lang-key="logoutBtn">
          <div class="sign"><svg viewBox="0 0 512 512"><path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"></path></svg></div>
          <div class="text">Logout</div>
        </button>
      </div>
      
    </div>

    <div class="modal-overlay" id="profile-upload-modal">
        </div>

    <div class="modal-overlay" id="settings-modal">
        </div>
    
    <div class="modal-overlay" id="profile-settings-modal">
        </div>

    <div class="modal-overlay" id="notifications-settings-modal">
        </div>
    
    <div class="modal-overlay" id="logout-confirm-modal">
        </div>

    <div class="modal-overlay" id="delete-account-modal-step1">
        </div>
    
    <div class="modal-overlay" id="delete-account-modal-step2">
        </div>
    
    <div id="toast-notification" style="display: none;">
      </div>
    
     <a href="index.html" class="cta-button back-button" data-lang-key="backToHome">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</a>
        </main>

</body>
</html>