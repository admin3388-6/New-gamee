<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SkyData - شراء الباقات</title>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<script src="https://www.paypal.com/sdk/js?client-id=AdJS2-N0gNZpKLNlpf1BaLfjMZN7NVcLSz7WxEh3r6t8uCSy-fDb-iQQzwo6U14RypULVhRdhOasW1wj&currency=USD"></script>

<style>
  /* --- (هذا هو كل الـ CSS المنسوخ من login.html) --- */
  :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --glow-color-1: #6366f1;
      --glow-color-2: #ec4899;
      --glow-color-3: #f59e0b;
      --dark-bg: #0d0d1a; 
      --bg-surface: #1a1a2e;
      --text-color: #e0e0e0;
      --text-muted: #aaa;
      --border-color: #333;
      --error-color: #EF665B;
      --success-color: #28a745;
  }
  * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }
  #app-container {
      width: 100%; overflow-x: hidden; position: relative; 
      transform: translate3d(0, 0, 0); min-height: 100vh;
      display: flex; flex-direction: column;
  }
  html { }
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    direction: rtl; background-color: var(--dark-bg); 
    color: var(--text-color); margin: 0; padding: 0; 
  }
  body::before {
      content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, rgba(var(--glow-color-1), 0.15), rgba(var(--glow-color-2), 0.1), rgba(var(--glow-color-3), 0.15));
      background-size: 400% 400%;
      animation: glowingBackground 20s ease infinite;
      z-index: -1; filter: blur(50px);
  }
  @keyframes glowingBackground { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; background-color: rgba(26, 26, 46, 0.7); 
      backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); 
      box-shadow: 0 2px 10px rgba(0,0,0,0.3); width: 100%;
      position: sticky; top: 0; z-index: 100;
  }
  .logo-container { display: flex; align-items: center; }
  .logo-container img { height: 35px; margin-left: 10px; }
  .logo-shine { position: relative; overflow: hidden; }
  .logo-shine::after {
      content: ''; position: absolute; top: 0; left: -100%;
      width: 50%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: skewX(-25deg); animation: shine-effect 5s infinite linear;
  }
  @keyframes shine-effect { 0% { left: -100%; } 50% { left: 150%; } 100% { left: 150%; } }
  .lang-switcher { display: flex; align-items: center; }
  .lang-switcher a { 
      text-decoration: none; color: var(--primary-color); margin: 0 3px; 
      font-weight: bold; cursor: pointer; padding: 4px 7px; 
      border-radius: 5px; transition: all 0.2s ease;
  }
  .lang-switcher a.active { background-color: var(--primary-color); color: #ffffff; }
  main {
      flex-grow: 1; display: flex;
      justify-content: center; align-items: center;
      padding: 30px 0; 
  }
  .main-wrapper { max-width: 400px; width: 95%; }
  footer {
      background-color: rgba(26, 26, 46, 0.7); backdrop-filter: blur(10px);
      color: #fff; padding: 30px 20px; text-align: center;
      margin-top: auto; border-top: 1px solid var(--border-color); width: 100%;
  }
  .footer-links-card {
      margin: 0 auto; border: 1px solid var(--border-color);
      background: rgba(0,0,0,0.2); padding: 20px;
      border-radius: 12px; max-width: 400px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }
  .footer-links-card a {
      color: var(--text-muted); text-decoration: none; font-size: 1.1em;
      transition: color 0.2s ease; display: block; margin: 10px 0; 
  }
  .footer-links-card a:hover { color: var(--primary-color); }
  @media (max-width: 380px) {
      .logo-container img { height: 30px; }
      .lang-switcher a { padding: 3px 5px; font-size: 0.9em; }
  }
  .loader-spinner {
    border: 4px solid #333; border-top: 4px solid var(--primary-color);
    border-radius: 50%; width: 20px; height: 20px;
    animation: spin 1s linear infinite; display: none;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* --- (هذا هو الـ CSS الجديد الخاص بصفحة الباقات) --- */
  .pricing-container {
      display: flex;
      flex-direction: column; /* جعل الباقات عمودية */
      gap: 25px;
      padding: 0; /* الإطار الرئيسي يعتني بالحشو */
  }
  .plan-card {
      background-color: var(--bg-surface);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }
  .plan-card h3 {
      font-size: 1.8em;
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 10px;
  }
  .plan-card .price {
      font-size: 2.5em;
      font-weight: bold;
      color: var(--text-color);
  }
  /* حاوية زر PayPal */
  .paypal-button-container {
      margin-top: 20px;
      z-index: 10; /* ضمان ظهور الزر فوق أي شيء آخر */
  }
  #purchase-status {
      color: var(--text-muted);
      text-align: center;
      font-size: 1.1em;
      margin-top: 15px;
  }
</style>
</head>
<body>

<div id="app-container">
  <header>
      <div class="logo-container">
          <img src="https://i.ibb.co/hJ2nq38z/clouddata.webp" alt="شعار CloudData" class="logo-shine">
          <img src="https://i.ibb.co/v9zLrFg/skydata.webp" alt="شعار Skydata" class="logo-shine">
      </div>
      
      <div class="lang-switcher">
          <a href="dashboard.html" style="color: white; border: 1px solid white;">لوحة التحكم</a>
      </div>
  </header>

<main>
  <div class="main-wrapper">
      <h1 style="text-align: center;">اختر الباقة المناسبة لك</h1>
      <p id="purchase-status" style="text-align: center; color: var(--text-muted);">
          جاري التحقق من تسجيل الدخول...
      </p>

      <div class="pricing-container">
          <div class="plan-card">
              <h3>20 استخدام</h3>
              <div class="price">$1.99</div>
              <div class="paypal-button-container" id="paypal-btn-20" data-price="1.99" data-uses="20"></div>
          </div>
          
          <div class="plan-card">
              <h3>50 استخدام</h3>
              <div class="price">$3.99</div>
              <div class="paypal-button-container" id="paypal-btn-50" data-price="3.99" data-uses="50"></div>
          </div>
          
          <div class="plan-card">
              <h3>100 استخدام</h3>
              <div class="price">$7.00</div>
              <div class="paypal-button-container" id="paypal-btn-100" data-price="7.00" data-uses="100"></div>
          </div>
      </div>
      <div class="loader-spinner" id="loadingSpinner" style="display: none; margin: 20px auto;"></div>
  </div>
</main>

<footer>
    <div class="footer-links-card">
        <a href="Safety.html">شروط الاستخدام وسياسة الخصوصية</a>
        <a href="aboutus.html">عن Skydata</a>
    </div>
</footer>

</div> <script type="module">
    // *** تأكد من أن هذا المسار صحيح 100% ***
    import { app, database, auth } from '/rool/boomb/erdg/xoxo/Catchmeifyoucan/firebase-init.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const loadingSpinner = document.getElementById('loadingSpinner');
    const purchaseStatus = document.getElementById('purchase-status');
    const paypalContainers = document.querySelectorAll('.paypal-button-container');
    let currentUser = null;

    console.log("بدء تشغيل صفحة الباقات..."); // (للتأكد أن JS يعمل)

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("المستخدم مسجل دخوله:", user.uid); // (تتبع)
            currentUser = user;
            purchaseStatus.textContent = "أهلاً بك، " + (user.displayName || user.email);
            // الآن قم بعرض أزرار PayPal
            renderPayPalButtons(user.uid);
        } else {
            console.log("المستخدم ليس مسجل دخوله"); // (تتبع)
            currentUser = null;
            purchaseStatus.innerHTML = `الرجاء <a href="login.html">تسجيل الدخول</a> أولاً لتتمكن من الشراء`;
            paypalContainers.forEach(c => c.innerHTML = ""); // إخفاء الأزرار
        }
    });

    function renderPayPalButtons(userId) {
        console.log("بدء رسم أزرار PayPal..."); // (تتبع)
        
        paypalContainers.forEach(container => {
            const price = container.dataset.price;
            const uses = container.dataset.uses;

            // التأكد من عدم الرسم مرتين
            if (container.innerHTML.trim() !== "") {
                console.log("الأزرار مرسومة بالفعل لـ", container.id);
                return;
            }

            try {
                paypal.Buttons({
                    // 1. إخبار PayPal ما هي تفاصيل الطلب
                    createOrder: (data, actions) => {
                        console.log("إنشاء طلب لـ", price); // (تتبع)
                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: price // السعر من الزر
                                },
                                // إرسال البيانات إلى الخادم السري
                                custom_id: JSON.stringify({ userId: userId, uses: uses })
                            }]
                        });
                    },
                    
                    // 2. عند موافقة العميل على الدفع
                    onApprove: async (data, actions) => {
                        console.log("تمت الموافقة على الطلب:", data.orderID); // (تتبع)
                        loadingSpinner.style.display = 'block';
                        purchaseStatus.textContent = "جاري تأكيد الدفع... لا تغلق الصفحة";

                        try {
                            // 3. استدعاء الخادم السري (Vercel) لتأكيد الدفع
                            const response = await fetch('/api/capture-paypal', { // تأكد أن هذا المسار صحيح
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    orderID: data.orderID,
                                    userId: userId,
                                    uses: uses
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                // 4. نجح كل شيء!
                                console.log("نجح الالتقاط!"); // (تتبع)
                                loadingSpinner.style.display = 'none';
                                purchaseStatus.textContent = "تم الشراء بنجاح! يتم توجيهك إلى لوحة التحكم";
                                setTimeout(() => { window.location.href = 'dashboard.html'; }, 2000);
                            } else {
                                throw new Error(result.message || 'فشل تأكيد الدفع');
                            }
                        } catch (error) {
                            console.error("خطأ في الالتقاط:", error); // (تتبع)
                            loadingSpinner.style.display = 'none';
                            purchaseStatus.textContent = "خطأ فادح: " + error.message;
                        }
                    },
                    
                    // 5. عند حدوث خطأ في نافذة PayPal
                    onError: (err) => {
                        console.error("خطأ من PayPal SDK:", err); // (تتبع)
                        purchaseStatus.textContent = "حدث خطأ أثناء عملية الدفع";
                    }
                }).render(`#${container.id}`);
            } catch (sdkError) {
                 console.error("خطأ فادح في PayPal SDK:", sdkError); // (تتبع)
                 purchaseStatus.textContent = "خطأ في تحميل PayPal، حاول تحديث الصفحة";
            }
        });
    }
</script>
</body>
</html>
