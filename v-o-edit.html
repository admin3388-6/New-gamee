<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>SkyData - استوديو المونتاج</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        /* نفس تنسيقات الستايل العامة */
        body { background-color: #0b132b; padding-top: 80px; font-family: 'Cairo', sans-serif; overflow-x: hidden; user-select: none; }
        
        /* الهيدر والقائمة (تمت إعادتها) */
        .main-header { height: 70px !important; background-color: #0b132b !important; border-bottom: 1px solid #1f2d4d; position: fixed; top: 0; width: 100%; z-index: 2000; display: flex !important; align-items: center !important; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .main-header .container { width: 100% !important; padding: 0 20px !important; display: flex !important; justify-content: space-between !important; align-items: center !important; }
        .logo-img { height: 35px !important; width: auto; }
        
        .sidebar { z-index: 2001 !important; padding-top: 20px !important; background-color: #111a30; box-shadow: -5px 0 20px rgba(0,0,0,0.5); position: fixed; top: 0; right: -320px; width: 300px; height: 100vh; transition: right 0.3s ease; overflow-y: auto; }
        .sidebar.open { right: 0; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1500; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(3px); }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        
        /* تنسيقات المحرر */
        .container-editor { max-width: 1000px; margin: 0 auto; padding: 15px; }
        .editor-box { background-color: #111a30; padding: 20px; border-radius: 15px; border: 1px solid #2a3a5a; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        
        .preview-container { width: 100%; background: #000; border-radius: 10px; margin-bottom: 20px; position: relative; display: flex; justify-content: center; align-items: center; min-height: 300px; border: 1px solid #333; }
        video, audio { max-width: 100%; max-height: 400px; width: 100%; }
        
        .upload-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111a30; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .upload-btn { padding: 15px 40px; background: #00aaff; color: #fff; font-size: 18px; border-radius: 50px; cursor: pointer; transition: 0.3s; border: none; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        
        .timeline-wrapper { position: relative; height: 80px; background: #0e1624; border-radius: 8px; margin: 20px 0; border: 1px solid #2a3a5a; cursor: pointer; touch-action: none; }
        .timeline-track { position: absolute; top: 50%; left: 0; width: 100%; height: 4px; background: #333; transform: translateY(-50%); }
        .timeline-fill { position: absolute; top: 50%; height: 4px; background: #00aaff; transform: translateY(-50%); left: 0; width: 100%; }
        .handle { position: absolute; top: 10px; width: 20px; height: 60px; background: #fff; border-radius: 4px; cursor: ew-resize; z-index: 5; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .handle::after { content: '||'; color: #333; font-size: 10px; font-weight: bold; }
        .handle-left { left: 0; background: #00aaff; } .handle-right { right: 0; background: #00aaff; }
        
        .toolbar { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; padding-top: 20px; border-top: 1px solid #2a3a5a; }
        .tool-btn { background: #1f2d4d; color: #fff; border: 1px solid #2a3a5a; width: 50px; height: 50px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; position: relative; }
        .tool-btn:hover { background: #00aaff; color: #111; transform: translateY(-3px); }
        .tool-btn.active { background: #00aaff; color: #111; border-color: #fff; box-shadow: 0 0 15px rgba(0, 170, 255, 0.4); }
        .tool-btn-text { position: absolute; bottom: -25px; font-size: 11px; color: #aaa; width: 100px; text-align: center; }
        .btn-save { background: #27ae60; color: #fff; padding: 0 30px; width: auto; font-weight: bold; font-size: 16px; }

        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(11, 19, 43, 0.95); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .loader-spin { width: 50px; height: 50px; border: 5px solid #2a3a5a; border-top-color: #00aaff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* تنبيه الأمان */
        .security-warning {
            color: #ff4d4d; margin-top: 20px; font-size: 13px; background: rgba(255,0,0,0.1); padding: 10px; border-radius: 5px; display: none;
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <header class="main-header">
        <div class="container">
            <a href="index.html" class="logo">
                <img src="https://i.ibb.co/v4vwvcGq/skydatafull.webp" alt="SkyData" class="logo-img">
            </a>
            <label class="hamburger menu-toggle">
              <input type="checkbox" id="menu-checkbox">
              <svg viewBox="0 0 32 32">
                <path class="line line-top-bottom" d="M27 10 13 10C10.8 10 9 8.2 9 6 9 3.5 10.8 2 13 2 15.2 2 17 3.8 17 6L17 26C17 28.2 18.8 30 21 30 23.2 30 25 28.2 25 26 25 23.8 23.2 22 21 22L7 22"></path>
                <path class="line" d="M7 16 27 16"></path>
              </svg>
            </label>
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <h4>القائمة</h4>
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> <span>المنزل</span></a></li>
                <li><a href="menu.html"><i class="fas fa-th-large"></i> <span>لوحة التحكم</span></a></li>
            </ul>
        </div>
    </nav>

    <main class="container-editor">
        <div class="editor-box">
            <div id="upload-screen" class="upload-overlay">
                <input type="file" id="file-input" accept="video/*,audio/*" style="display:none">
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-plus-circle"></i> اختر فيديو أو صوت
                </button>
                <p style="color:#777; margin-top:15px; font-size:12px;">الحد الأقصى: 1 جيجا | المدة: 1 ساعة</p>
            </div>

            <div id="loader">
                <div class="loader-spin"></div>
                <p id="loader-msg" style="margin-top:15px; color:#fff;">جاري تهيئة المعالج...</p>
                <div id="security-warning" class="security-warning">
                    ⚠️ تنبيه: لم يتم تفعيل "SharedArrayBuffer". إذا استمر التحميل طويلاً، يرجى التأكد من إضافة ملف vercel.json
                </div>
            </div>

            <div class="preview-container">
                <video id="main-player" controlsList="nodownload"></video>
                <audio id="audio-player" controls style="display:none;"></audio>
            </div>

            <div class="timeline-wrapper" id="timeline">
                <div class="timeline-track"></div>
                <div class="timeline-fill" id="progress-fill"></div>
                <div class="handle handle-left" id="handle-start"></div>
                <div class="handle handle-right" id="handle-end"></div>
            </div>

            <div class="toolbar">
                <button class="tool-btn" onclick="togglePlay()"><i class="fas fa-play" id="play-icon"></i></button>
                <button class="tool-btn btn-save" onclick="processAndSave()"><i class="fas fa-save"></i> حفظ</button>
                <button class="tool-btn" onclick="location.reload()"><i class="fas fa-redo"></i></button>
            </div>
        </div>
    </main>

    <script>
        // --- القائمة الجانبية ---
        const menuCheckbox = document.getElementById('menu-checkbox');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        function toggleMenu(open) {
            if(open) { sidebar.classList.add('open'); overlay.classList.add('active'); menuCheckbox.checked = true; }
            else { sidebar.classList.remove('open'); overlay.classList.remove('active'); menuCheckbox.checked = false; }
        }
        menuCheckbox.addEventListener('change', (e) => toggleMenu(e.target.checked));
        overlay.addEventListener('click', () => toggleMenu(false));

        // --- منطق FFmpeg ---
        const { createFFmpeg, fetchFile } = FFmpeg;
        let ffmpeg = null;

        // التحقق من دعم المتصفح
        if (!crossOriginIsolated) {
            // إذا لم تكن الهيدرز موجودة، ستفشل المكتبة. نظهر رسالة تحذير.
            document.getElementById('security-warning').style.display = 'block';
        }

        ffmpeg = createFFmpeg({ 
            log: true,
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
        });

        // --- المتغيرات ---
        let mediaFile = null;
        let duration = 0;
        let trimStart = 0;
        let trimEnd = 0;

        const player = document.getElementById('main-player');
        const audioPlayer = document.getElementById('audio-player');
        const handleStart = document.getElementById('handle-start');
        const handleEnd = document.getElementById('handle-end');

        // --- عند رفع الملف ---
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loader-msg').innerText = 'جاري تحميل المحرك (قد يستغرق وقتاً)...';

            try {
                if(!ffmpeg.isLoaded()) await ffmpeg.load();
            } catch(err) {
                alert("فشل تحميل المحرك. تأكد من إعدادات Vercel Headers.");
                document.getElementById('loader').style.display = 'none';
                return;
            }

            mediaFile = file;
            const url = URL.createObjectURL(file);
            const isVideo = file.type.startsWith('video');

            if(isVideo) {
                player.src = url; player.style.display = 'block'; audioPlayer.style.display = 'none';
                player.onloadedmetadata = () => initEditor(player.duration);
            } else {
                audioPlayer.src = url; audioPlayer.style.display = 'block'; player.style.display = 'none';
                audioPlayer.onloadedmetadata = () => initEditor(audioPlayer.duration);
            }
        });

        function initEditor(dur) {
            duration = dur;
            trimStart = 0;
            trimEnd = duration;
            document.getElementById('upload-screen').style.display = 'none';
            document.getElementById('loader').style.display = 'none';
            updateHandles();
        }

        // --- تحريك المقابض ---
        let dragging = null;
        const timeline = document.getElementById('timeline');

        [handleStart, handleEnd].forEach(h => {
            h.addEventListener('mousedown', (e) => { dragging = h; e.preventDefault(); });
            h.addEventListener('touchstart', (e) => { dragging = h; e.preventDefault(); });
        });

        window.addEventListener('mouseup', () => dragging = null);
        window.addEventListener('touchend', () => dragging = null);

        window.addEventListener('mousemove', moveHandle);
        window.addEventListener('touchmove', (e) => moveHandle(e.touches[0]));

        function moveHandle(e) {
            if(!dragging) return;
            const rect = timeline.getBoundingClientRect();
            const x = e.clientX - rect.left;
            let percent = Math.max(0, Math.min(1, x / rect.width));
            let time = percent * duration;

            if(dragging === handleStart) {
                if(time < trimEnd) trimStart = time;
            } else {
                if(time > trimStart) trimEnd = time;
            }
            
            updateHandles();
            const p = player.style.display !== 'none' ? player : audioPlayer;
            p.currentTime = time;
        }

        function updateHandles() {
            const startPct = (trimStart / duration) * 100;
            const endPct = (trimEnd / duration) * 100;
            
            handleStart.style.left = startPct + '%';
            handleEnd.style.left = endPct + '%';
            document.getElementById('progress-fill').style.left = startPct + '%';
            document.getElementById('progress-fill').style.width = (endPct - startPct) + '%';
        }

        function togglePlay() {
            const p = player.style.display !== 'none' ? player : audioPlayer;
            if(p.paused) { p.currentTime = trimStart; p.play(); }
            else p.pause();
        }

        // --- الحفظ والقص ---
        async function processAndSave() {
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            document.getElementById('loader-msg').innerText = 'جاري القص...';

            try {
                const ext = mediaFile.name.split('.').pop();
                const inputName = 'input.' + ext;
                const outputName = 'output.' + ext;

                ffmpeg.FS('writeFile', inputName, await fetchFile(mediaFile));

                // الأمر السحري: -ss (بداية) -to (نهاية) -c copy (بدون إعادة تشفير = سرعة خيالية)
                await ffmpeg.run('-i', inputName, '-ss', trimStart.toString(), '-to', trimEnd.toString(), '-c', 'copy', outputName);

                const data = ffmpeg.FS('readFile', outputName);
                const url = URL.createObjectURL(new Blob([data.buffer], { type: mediaFile.type }));
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `edited_${mediaFile.name}`;
                a.click();
                
                alert("تم الحفظ بنجاح!");
            } catch(e) {
                console.error(e);
                alert("حدث خطأ. قد يكون بسبب عدم دعم المتصفح.");
            } finally {
                loader.style.display = 'none';
            }
        }
    </script>
    
    <script type="module">
    import { updateAuthUI } from './firebase-config.js';
    updateAuthUI();
    </script>
</body>
</html>