<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SkyData - Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
<style>
  @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
  }
  body { 
    font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0; 
    display:flex; justify-content:center; align-items:center; min-height:100vh; 
    direction: rtl; 
  }
  .container { 
    background:#fff; padding:30px; border-radius:10px; 
    box-shadow:0 0 20px rgba(0,0,0,0.15); width:100%; max-width:400px;
    animation: fadeIn 0.5s ease-out;
  }
  h2 { text-align:center; margin-bottom:20px; color: #007BFF; }
  .home { display:flex; flex-direction:column; text-align:center; align-items: center; }
  h3 { color: #28a745; margin-top: 5px; }
  #currentSubscription { font-size: 1em; margin-top: 15px; padding: 10px; background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 5px; width: 100%; }
  .cta-button { 
    width:100%; padding:12px; background:#007BFF; color:#fff; border:none; 
    border-radius:5px; cursor:pointer; margin-top:20px; transition: background 0.3s; 
    font-size: 1.1em; font-weight: bold;
    max-width: 250px; margin-top: 15px;
  }
  #unsubscribeBtn { background: #dc3545; }
  #unsubscribeBtn:hover { background: #c82333; }
  #resubscribeBtn { background: #28a745; }
  #resubscribeBtn:hover { background: #1e7e34; }
  #logoutBtn { background: #555; margin-top: 25px; }
  #logoutBtn:hover { background: #333; }
  
  .message { padding: 10px; border-radius: 5px; margin-top: 15px; text-align: center; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  
  /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø³ÙŠØ· */
  .loader {
    text-align: center;
    color: #007BFF;
    font-size: 1.2em;
    padding: 30px;
  }
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getDatabase, ref, update, get, child } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
  
  // ğŸ›‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù† Ù…Ø´Ø±ÙˆØ¹ skydata-ai)
  const firebaseConfig = {
    apiKey: "AIzaSyAw_EI5sOrqvxWn-5DZgG_t0rgF910T-wE",
    authDomain: "skydata-ai.firebaseapp.com",
    databaseURL: "https://skydata-ai-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "skydata-ai",
    storageBucket: "skydata-ai.firebasestorage.app",
    messagingSenderId: "165531796197",
    appId: "1:165531796197:web:8dcd76fc9ec5dedb994a0c",
    measurementId: "G-JYS7P7FY3Z"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // **************************************************
  // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
  // **************************************************

  // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
  async function getSubscription(uid) {
      const dbRef = ref(db);
      try {
          const snapshot = await get(child(dbRef, `users/${uid}`));
          if (snapshot.exists()) {
              return snapshot.val().subscribe_marketing === true;
          } else {
              return false;
          }
      } catch (error) {
          console.error("Error getting subscription:", error);
          return false;
      }
  }
  
  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
  function updateSubscription(uid, subscribe) {
    update(ref(db, 'users/' + uid), { subscribe_marketing: subscribe });
  }
  
  // ğŸ›‘ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø´ÙƒØ± Ø¹Ø¨Ø± API Proxy Ø¹Ù„Ù‰ Vercel
  async function sendOneSignalEmail(email, action) {
      try {
        // ğŸ›‘ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† OneSignal Ù…Ø¨Ø§Ø´Ø±Ø©
        const response = await fetch('/api/send-email', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            email: email,
            action: action // 'resubscribe' Ø£Ùˆ 'subscribe'
          })
        });

        if (response.ok) {
            console.log("Email sent successfully via Vercel Proxy.");
        } else {
            const errorDetails = await response.json();
            console.error("Proxy Email failed:", errorDetails);
        }
      } catch (err){ 
          console.error("Proxy Fetch Error:", err); 
      }
  }


  // **************************************************
  // Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  // **************************************************

  const userEmailEl = document.getElementById('userEmail');
  const currentSubscriptionEl = document.getElementById('currentSubscription');
  const welcomeHeader = document.getElementById('welcomeHeader');
  const unsubscribeBtn = document.getElementById('unsubscribeBtn');
  const resubscribeBtn = document.getElementById('resubscribeBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const homeMsg = document.getElementById('homeMsg');
  const contentContainer = document.getElementById('contentContainer');
  const loaderContainer = document.getElementById('loaderContainer');
  
  let currentUser = null;
  let isSubscribed = false;


  function updateHomeSubscriptionUI() {
      const subText = isSubscribed 
          ? 'Ù…Ø´ØªØ±Ùƒ: ØªØµÙ„Ùƒ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª.'
          : 'ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ: Ù„Ø§ ØªØµÙ„Ùƒ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø±ÙŠØ¯ ØªØ³ÙˆÙŠÙ‚ÙŠ.';
      
      currentSubscriptionEl.textContent = subText;
      resubscribeBtn.style.display = isSubscribed ? 'none' : 'block';
      unsubscribeBtn.style.display = isSubscribed ? 'block' : 'none';
  }
  
  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† ØµÙØ­Ø© Home
  async function handleSubscriptionChange(subscribe) {
      if(currentUser) {
          updateSubscription(currentUser.uid, subscribe);
          isSubscribed = subscribe; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
          updateHomeSubscriptionUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          homeMsg.textContent = subscribe 
            ? 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ.'
            : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­.';
          
          if (subscribe) {
              await sendOneSignalEmail(currentUser.email, 'resubscribe'); // ğŸ›‘ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Proxy
          }
      }
  }

  // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  resubscribeBtn.addEventListener('click', () => handleSubscriptionChange(true));
  unsubscribeBtn.addEventListener('click', () => handleSubscriptionChange(false));

  logoutBtn.addEventListener('click', function(){
    signOut(auth).then(()=>{
      // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
      window.location.href = "login.html";
    }).catch(error => {
        homeMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.';
    });
  });


  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  onAuthStateChanged(auth, async user => {
      if (user) {
          currentUser = user;
          
          // 1. Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Firebase
          isSubscribed = await getSubscription(user.uid);
          
          // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          const userName = user.email.split('@')[0];
          welcomeHeader.textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ, ${userName}!`;
          userEmailEl.textContent=`Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${user.email}`;
          updateHomeSubscriptionUI();
          
          loaderContainer.style.display = 'none';
          contentContainer.style.display = 'flex';
          
      } else {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ Ø£Ø¹Ø¯ ØªÙˆØ¬ÙŠÙ‡Ù‡
          window.location.href = "login.html";
      }
  });

</script>

</head>
<body>
    <div class="loader" id="loaderContainer">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <div class="container home" id="contentContainer" style="display: none;">
      <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ SkyData!</h2>
      
      <h3 id="welcomeHeader"></h3>
      <p id="userEmail"></p>
      
      <div id="currentSubscription"></div>
      
      <button id="resubscribeBtn" class="cta-button">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ</button>
      <button id="unsubscribeBtn" class="cta-button">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
      
      <button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      
      <div class="message" id="homeMsg"></div>
    </div>
</body>
</html>