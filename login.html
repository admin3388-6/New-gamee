<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SkyData - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
<style>
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
  }

  body { 
    font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0; 
    display:flex; justify-content:center; align-items:center; min-height:100vh; 
    direction: rtl; 
  }
  .container { 
    background:#fff; padding:30px; border-radius:10px; 
    box-shadow:0 0 20px rgba(0,0,0,0.15); width:100%; max-width:400px;
    animation: fadeIn 0.5s ease-out;
  }
  h2 { text-align:center; margin-bottom:20px; color: #007BFF; }
  input[type="email"], input[type="password"] { 
    width:100%; padding:10px; margin:10px 0 15px 0; border-radius:5px; 
    border:1px solid #ccc; box-sizing: border-box; 
    direction: ltr;
  }
  label { display:block; margin:5px 0; font-weight: bold; }
  
  .cta-button { 
    width:100%; padding:12px; background:#007BFF; color:#fff; border:none; 
    border-radius:5px; cursor:pointer; margin-top:20px; transition: background 0.3s; 
    font-size: 1.1em; font-weight: bold;
  }
  .cta-button:hover:not(:disabled) { background:#0056b3; }
  .cta-button:disabled { background: #ccc; cursor: not-allowed; }
  
  .subscription-checkbox {
    margin: 15px 0;
    padding: 10px;
    border: 1px dashed #ddd;
    border-radius: 5px;
  }
  .subscription-checkbox label {
    font-weight: normal;
    display: flex;
    align-items: center;
    cursor: pointer;
  }
  .subscription-checkbox input[type="checkbox"] {
    margin: 0 0 0 10px;
    width: auto;
  }

  .terms { font-size:12px; margin-top:15px; text-align:center; }
  .terms a { color: #007BFF; text-decoration: none; }
  .verification { margin-top:20px; padding:10px; background:#e2f0d9; border:1px solid #b2d8a8; border-radius:5px; text-align:center; font-size: 0.9em; }
  
  .message, .error { padding: 10px; border-radius: 5px; margin-top: 15px; text-align: center; }
  .message { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

  .loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007BFF;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    display: none;
    margin: 0 auto;
  }
  .toggle-link {
    display: block;
    text-align: center;
    margin-top: 15px;
    color: #007BFF;
    cursor: pointer;
    font-size: 0.95em;
    text-decoration: none;
  }
  .toggle-link:hover { text-decoration: underline; }

</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  // ğŸ›‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù† Ù…Ø´Ø±ÙˆØ¹ skydata-ai)
  const firebaseConfig = {
    apiKey: "AIzaSyAw_EI5sOrqvxWn-5DZgG_t0rgF910T-wE",
    authDomain: "skydata-ai.firebaseapp.com",
    databaseURL: "https://skydata-ai-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "skydata-ai",
    storageBucket: "skydata-ai.firebasestorage.app",
    messagingSenderId: "165531796197",
    appId: "1:165531796197:web:8dcd76fc9ec5dedb994a0c",
    measurementId: "G-JYS7P7FY3Z"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (true/false)
  function updateSubscription(uid, subscribe) {
    update(ref(db, 'users/' + uid), { 
      subscribe_marketing: subscribe,
      timestamp: Date.now()
    });
  }

  // ÙˆØ¶Ø¹ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
  window.auth = auth;
  window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.sendEmailVerification = sendEmailVerification;
  window.updateSubscription = updateSubscription;
  window.onAuthStateChanged = onAuthStateChanged; 
  
</script>

<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>

<body>

<div class="container" id="loginContainer">
  <h2 id="formTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  
  <form id="authForm">
    <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
    <input type="email" id="email" required placeholder="example@skydata.com" autocomplete="email">

    <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
    <input type="password" id="password" required placeholder="********" autocomplete="current-password">

    <div class="subscription-checkbox" id="subscriptionBox" style="display: none;">
      <label for="subscribeEmail">
        <input type="checkbox" id="subscribeEmail" checked>
        Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ„Ø§Ù… **Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ**ØŒ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±ØŒ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ¹Ø¬Ù„Ø©.
      </label>
    </div>
    
    <button type="submit" class="cta-button" id="submitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    
    <div class="loader" id="loadingSpinner"></div>

    <a href="#" class="toggle-link" id="toggleModeLink">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
  </form>

  <div class="terms">
    Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ 
    <a href="Safety.html" target="_blank">Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
  </div>

  <div class="verification">
    Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† OneSignal: <strong>OS7K3L</strong>
  </div>

  <div class="message" id="msg"></div>
  <div class="error" id="err"></div>
</div>


<script type="module">
  // **************************************************
  // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  // **************************************************

  // ğŸ›‘ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø­Ø³Ø§Ø³Ø©! Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù† Ø§Ù„Ù€ Proxy ÙÙ‚Ø·.
  
  // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
  const auth = window.auth;
  const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
  const createUserWithEmailAndPassword = window.createUserWithEmailAndPassword;
  const sendEmailVerification = window.sendEmailVerification;
  const updateSubscription = window.updateSubscription;
  const onAuthStateChanged = window.onAuthStateChanged; 
  
  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const formTitle = document.getElementById('formTitle');
  const authForm = document.getElementById('authForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const submitBtn = document.getElementById('submitBtn');
  const toggleModeLink = document.getElementById('toggleModeLink');
  const subscriptionBox = document.getElementById('subscriptionBox');
  const subscribeEmailCheckbox = document.getElementById('subscribeEmail');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const msgEl = document.getElementById('msg');
  const errEl = document.getElementById('err');
  
  // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  let isLoginMode = true;

  // **************************************************
  // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
  // **************************************************

  // ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
  function toggleMode() {
    isLoginMode = !isLoginMode;
    msgEl.textContent = '';
    errEl.textContent = '';
    
    if (isLoginMode) {
      formTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      toggleModeLink.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      subscriptionBox.style.display = 'none';
      passwordInput.setAttribute('autocomplete', 'current-password');
    } else {
      formTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      toggleModeLink.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      subscriptionBox.style.display = 'block';
      passwordInput.setAttribute('autocomplete', 'new-password');
    }
  }
  
  // ğŸ›‘ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø´ÙƒØ± Ø¹Ø¨Ø± API Proxy Ø¹Ù„Ù‰ Vercel
  async function sendOneSignalEmail(email) {
      try {
        // ğŸ›‘ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† OneSignal Ù…Ø¨Ø§Ø´Ø±Ø©
        const response = await fetch('/api/send-email', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            email: email,
            action: 'subscribe' // Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø£Ù† Ù‡Ø°Ø§ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯
          })
        });

        if (response.ok) {
            console.log("Email sent successfully via Vercel Proxy.");
        } else {
            const errorDetails = await response.json();
            console.error("Proxy Email failed:", errorDetails);
        }
      } catch (err){ 
          console.error("Proxy Fetch Error:", err); 
      }
  }


  // **************************************************
  // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  // **************************************************

  toggleModeLink.addEventListener('click', (e) => {
    e.preventDefault();
    toggleMode();
  });
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨)
  authForm.addEventListener('submit', async function(e){
    e.preventDefault();
    errEl.textContent=''; msgEl.textContent='';
    const email = emailInput.value;
    const password = passwordInput.value;
    const subscribe = subscribeEmailCheckbox.checked;

    submitBtn.disabled = true;
    loadingSpinner.style.display = 'block';

    try {
      if (isLoginMode) {
        // ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        updateSubscription(user.uid, subscribe); 
        
        window.location.href = "home.html";
        
      } else {
        // ÙˆØ¶Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        updateSubscription(user.uid, subscribe);
        await sendEmailVerification(user);
        
        if (subscribe) {
            await sendOneSignalEmail(email); // ğŸ›‘ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯
        }

        msgEl.innerHTML = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ **Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„** Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${email}.<br>**ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Spam) Ø¥Ø°Ø§ Ù„Ù… ØªØµÙ„Ùƒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚.**`;
        
        setTimeout(() => {
             window.location.href = "home.html";
        }, 3000); 
      }

    } catch(error){
      let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
      } else if (error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
      } else if (error.code === 'auth/weak-password') {
        errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
      }
      errEl.textContent = `ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${errorMessage}`;
      
    } finally {
      submitBtn.disabled = false;
      loadingSpinner.style.display = 'none';
    }
  });

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  onAuthStateChanged(auth, user => {
      if (user) {
          window.location.href = "home.html";
      } else {
          toggleMode();
      }
  });
</script>

</body>
</html>